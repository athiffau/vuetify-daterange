import '../../stylus/components/_time-picker-clock.styl';
// Mixins
import Colorable from '../../mixins/colorable';
import Themeable from '../../mixins/themeable';
import mixins from '../../util/mixins';
export default mixins(Colorable, Themeable
/* @vue/component */
).extend({
    name: 'v-time-picker-clock',
    props: {
        allowedValues: Function,
        disabled: Boolean,
        double: Boolean,
        format: {
            type: Function,
            default: (val) => val
        },
        max: {
            type: Number,
            required: true
        },
        min: {
            type: Number,
            required: true
        },
        scrollable: Boolean,
        readonly: Boolean,
        rotate: {
            type: Number,
            default: 0
        },
        step: {
            type: Number,
            default: 1
        },
        value: Number
    },
    data() {
        return {
            inputValue: this.value,
            isDragging: false,
            valueOnMouseDown: null,
            valueOnMouseUp: null
        };
    },
    computed: {
        count() {
            return this.max - this.min + 1;
        },
        degreesPerUnit() {
            return 360 / this.roundCount;
        },
        degrees() {
            return this.degreesPerUnit * Math.PI / 180;
        },
        displayedValue() {
            return this.value == null ? this.min : this.value;
        },
        innerRadiusScale() {
            return 0.62;
        },
        roundCount() {
            return this.double ? (this.count / 2) : this.count;
        }
    },
    watch: {
        value(value) {
            this.inputValue = value;
        }
    },
    methods: {
        wheel(e) {
            e.preventDefault();
            const delta = Math.sign(e.wheelDelta || 1);
            let value = this.displayedValue;
            do {
                value = value + delta;
                value = (value - this.min + this.count) % this.count + this.min;
            } while (!this.isAllowed(value) && value !== this.displayedValue);
            if (value !== this.displayedValue) {
                this.update(value);
            }
        },
        isInner(value) {
            return this.double && (value - this.min >= this.roundCount);
        },
        handScale(value) {
            return this.isInner(value) ? this.innerRadiusScale : 1;
        },
        isAllowed(value) {
            return !this.allowedValues || this.allowedValues(value);
        },
        genValues() {
            const children = [];
            for (let value = this.min; value <= this.max; value = value + this.step) {
                const color = value === this.value && (this.color || 'accent');
                children.push(this.$createElement('span', this.setBackgroundColor(color, {
                    staticClass: 'v-time-picker-clock__item',
                    'class': {
                        'v-time-picker-clock__item--active': value === this.displayedValue,
                        'v-time-picker-clock__item--disabled': this.disabled || !this.isAllowed(value)
                    },
                    style: this.getTransform(value),
                    domProps: { innerHTML: `<span>${this.format(value)}</span>` }
                })));
            }
            return children;
        },
        genHand() {
            const scale = `scaleY(${this.handScale(this.displayedValue)})`;
            const angle = this.rotate + this.degreesPerUnit * (this.displayedValue - this.min);
            const color = (this.value != null) && (this.color || 'accent');
            return this.$createElement('div', this.setBackgroundColor(color, {
                staticClass: 'v-time-picker-clock__hand',
                'class': {
                    'v-time-picker-clock__hand--inner': this.isInner(this.value)
                },
                style: {
                    transform: `rotate(${angle}deg) ${scale}`
                }
            }));
        },
        getTransform(i) {
            const { x, y } = this.getPosition(i);
            return {
                left: `${50 + x * 50}%`,
                top: `${50 + y * 50}%`
            };
        },
        getPosition(value) {
            const rotateRadians = this.rotate * Math.PI / 180;
            return {
                x: Math.sin((value - this.min) * this.degrees + rotateRadians) * this.handScale(value),
                y: -Math.cos((value - this.min) * this.degrees + rotateRadians) * this.handScale(value)
            };
        },
        onMouseDown(e) {
            e.preventDefault();
            this.valueOnMouseDown = null;
            this.valueOnMouseUp = null;
            this.isDragging = true;
            this.onDragMove(e);
        },
        onMouseUp() {
            this.isDragging = false;
            if (this.valueOnMouseUp !== null && this.isAllowed(this.valueOnMouseUp)) {
                this.$emit('change', this.valueOnMouseUp);
            }
        },
        onDragMove(e) {
            e.preventDefault();
            if (!this.isDragging && e.type !== 'click')
                return;
            const { width, top, left } = this.$refs.clock.getBoundingClientRect();
            const { width: innerWidth } = this.$refs.innerClock.getBoundingClientRect();
            const { clientX, clientY } = 'touches' in e ? e.touches[0] : e;
            const center = { x: width / 2, y: -width / 2 };
            const coords = { x: clientX - left, y: top - clientY };
            const handAngle = Math.round(this.angle(center, coords) - this.rotate + 360) % 360;
            const insideClick = this.double && this.euclidean(center, coords) < (innerWidth + innerWidth * this.innerRadiusScale) / 4;
            const value = Math.round(handAngle / this.degreesPerUnit) +
                this.min + (insideClick ? this.roundCount : 0);
            // Necessary to fix edge case when selecting left part of the value(s) at 12 o'clock
            let newValue;
            if (handAngle >= (360 - this.degreesPerUnit / 2)) {
                newValue = insideClick ? this.max - this.roundCount + 1 : this.min;
            }
            else {
                newValue = value;
            }
            if (this.isAllowed(value)) {
                if (this.valueOnMouseDown === null) {
                    this.valueOnMouseDown = newValue;
                }
                this.valueOnMouseUp = newValue;
                this.update(newValue);
            }
        },
        update(value) {
            if (this.inputValue !== value) {
                this.inputValue = value;
                this.$emit('input', value);
            }
        },
        euclidean(p0, p1) {
            const dx = p1.x - p0.x;
            const dy = p1.y - p0.y;
            return Math.sqrt(dx * dx + dy * dy);
        },
        angle(center, p1) {
            const value = 2 * Math.atan2(p1.y - center.y - this.euclidean(center, p1), p1.x - center.x);
            return Math.abs(value * 180 / Math.PI);
        }
    },
    render(h) {
        const data = {
            staticClass: 'v-time-picker-clock',
            class: {
                'v-time-picker-clock--indeterminate': this.value == null,
                ...this.themeClasses
            },
            on: (this.readonly || this.disabled) ? undefined : Object.assign({
                mousedown: this.onMouseDown,
                mouseup: this.onMouseUp,
                mouseleave: () => (this.isDragging && this.onMouseUp()),
                touchstart: this.onMouseDown,
                touchend: this.onMouseUp,
                mousemove: this.onDragMove,
                touchmove: this.onDragMove
            }, this.scrollable ? {
                wheel: this.wheel
            } : {}),
            ref: 'clock'
        };
        return h('div', data, [
            h('div', {
                staticClass: 'v-time-picker-clock__inner',
                ref: 'innerClock'
            }, [
                this.genHand(),
                this.genValues()
            ])
        ]);
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlRpbWVQaWNrZXJDbG9jay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZUaW1lUGlja2VyL1ZUaW1lUGlja2VyQ2xvY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxpREFBaUQsQ0FBQTtBQUV4RCxTQUFTO0FBQ1QsT0FBTyxTQUFTLE1BQU0sd0JBQXdCLENBQUE7QUFDOUMsT0FBTyxTQUFTLE1BQU0sd0JBQXdCLENBQUE7QUFDOUMsT0FBTyxNQUFzQixNQUFNLG1CQUFtQixDQUFBO0FBZXRELGVBQWUsTUFBTSxDQVFuQixTQUFTLEVBQ1QsU0FBUztBQUNYLG9CQUFvQjtDQUNuQixDQUFDLE1BQU0sQ0FBQztJQUNQLElBQUksRUFBRSxxQkFBcUI7SUFFM0IsS0FBSyxFQUFFO1FBQ0wsYUFBYSxFQUFFLFFBQVE7UUFDdkIsUUFBUSxFQUFFLE9BQU87UUFDakIsTUFBTSxFQUFFLE9BQU87UUFDZixNQUFNLEVBQUU7WUFDTixJQUFJLEVBQUUsUUFBUTtZQUNkLE9BQU8sRUFBRSxDQUFDLEdBQW9CLEVBQUUsRUFBRSxDQUFDLEdBQUc7U0FDdkM7UUFDRCxHQUFHLEVBQUU7WUFDSCxJQUFJLEVBQUUsTUFBTTtZQUNaLFFBQVEsRUFBRSxJQUFJO1NBQ2Y7UUFDRCxHQUFHLEVBQUU7WUFDSCxJQUFJLEVBQUUsTUFBTTtZQUNaLFFBQVEsRUFBRSxJQUFJO1NBQ2Y7UUFDRCxVQUFVLEVBQUUsT0FBTztRQUNuQixRQUFRLEVBQUUsT0FBTztRQUNqQixNQUFNLEVBQUU7WUFDTixJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxJQUFJLEVBQUU7WUFDSixJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxLQUFLLEVBQUUsTUFBTTtLQUNkO0lBRUQsSUFBSTtRQUNGLE9BQU87WUFDTCxVQUFVLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFD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SSxJQUFJO2dCQUN4RCxHQUFHLElBQUksQ0FBQyxZQUFZO2FBQ3JCO1lBQ0QsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztnQkFDL0QsU0FBUyxFQUFFLElBQUksQ0FBQyxXQUFXO2dCQUMzQixPQUFPLEVBQUUsSUFBSSxDQUFDLFNBQVM7Z0JBQ3ZCLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUN2RCxVQUFVLEVBQUUsSUFBSSxDQUFDLFdBQVc7Z0JBQzVCLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUztnQkFDeEIsU0FBUyxFQUFFLElBQUksQ0FBQyxVQUFVO2dCQUMxQixTQUFTLEVBQUUsSUFBSSxDQUFDLFVBQVU7YUFDM0IsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDbkIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO2FBQ2xCLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUNQLEdBQUcsRUFBRSxPQUFPO1NBQ2IsQ0FBQTtRQUVELE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUU7WUFDcEIsQ0FBQyxDQUFDLEtBQUssRUFBRTtnQkFDUCxXQUFXLEVBQUUsNEJBQTRCO2dCQUN6QyxHQUFHLEVBQUUsWUFBWTthQUNsQixFQUFFO2dCQUNELElBQUksQ0FBQyxPQUFPLEVBQUU7Z0JBQ2QsSUFBSSxDQUFDLFNBQVMsRUFBRTthQUNqQixDQUFDO1NBQ0gsQ0FBQyxDQUFBO0lBQ0osQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnLi4vLi4vc3R5bHVzL2NvbXBvbmVudHMvX3RpbWUtcGlja2VyLWNsb2NrLnN0eWwnXHJcblxyXG4vLyBNaXhpbnNcclxuaW1wb3J0IENvbG9yYWJsZSBmcm9tICcuLi8uLi9taXhpbnMvY29sb3JhYmxlJ1xyXG5pbXBvcnQgVGhlbWVhYmxlIGZyb20gJy4uLy4uL21peGlucy90aGVtZWFibGUnXHJcbmltcG9ydCBtaXhpbnMsIHsgRXh0cmFjdFZ1ZSB9IGZyb20gJy4uLy4uL3V0aWwvbWl4aW5zJ1xyXG5pbXBvcnQgVnVlLCB7IFZOb2RlIH0gZnJvbSAndnVlJ1xyXG5cclxuaW50ZXJmYWNlIFBvaW50IHtcclxuICB4OiBudW1iZXJcclxuICB5OiBudW1iZXJcclxufVxyXG5cclxuaW50ZXJmYWNlIG9wdGlvbnMgZXh0ZW5kcyBWdWUge1xyXG4gICRyZWZzOiB7XHJcbiAgICBjbG9jazogSFRNTEVsZW1lbnRcclxuICAgIGlubmVyQ2xvY2s6IEhUTUxFbGVtZW50XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBtaXhpbnM8b3B0aW9ucyAmXHJcbi8qIGVzbGludC1kaXNhYmxlIGluZGVudCAqL1xyXG4gIEV4dHJhY3RWdWU8W1xyXG4gICAgdHlwZW9mIENvbG9yYWJsZSxcclxuICAgIHR5cGVvZiBUaGVtZWFibGVcclxuICBdPlxyXG4vKiBlc2xpbnQtZW5hYmxlIGluZGVudCAqL1xyXG4+KFxyXG4gIENvbG9yYWJsZSxcclxuICBUaGVtZWFibGVcclxuLyogQHZ1ZS9jb21wb25lbnQgKi9cclxuKS5leHRlbmQoe1xyXG4gIG5hbWU6ICd2LXRpbWUtcGlja2VyLWNsb2NrJyxcclxuXHJcbiAgcHJvcHM6IHtcclxuICAgIGFsbG93ZWRWYWx1ZXM6IEZ1bmN0aW9uLFxyXG4gICAgZGlzYWJsZWQ6IEJvb2xlYW4sXHJcbiAgICBkb3VibGU6IEJvb2xlYW4sXHJcbiAgICBmb3JtYXQ6IHtcclxuICAgICAgdHlwZTogRnVuY3Rpb24sXHJcbiAgICAgIGRlZmF1bHQ6ICh2YWw6IHN0cmluZyB8IG51bWJlcikgPT4gdmFsXHJcbiAgICB9LFxyXG4gICAgbWF4OiB7XHJcbiAgICAgIHR5cGU6IE51bWJlcixcclxuICAgICAgcmVxdWlyZWQ6IHRydWVcclxuICAgIH0sXHJcbiAgICBtaW46IHtcclxuICAgICAgdHlwZTogTnVtYmVyLFxyXG4gICAgICByZXF1aXJlZDogdHJ1ZVxyXG4gICAgfSxcclxuICAgIHNjcm9sbGFibGU6IEJvb2xlYW4sXHJcbiAgICByZWFkb25seTogQm9vbGVhbixcclxuICAgIHJvdGF0ZToge1xyXG4gICAgICB0eXBlOiBOdW1iZXIsXHJcbiAgICAgIGRlZmF1bHQ6IDBcclxuICAgIH0sXHJcbiAgICBzdGVwOiB7XHJcbiAgICAgIHR5cGU6IE51bWJlcixcclxuICAgICAgZGVmYXVsdDogMVxyXG4gICAgfSxcclxuICAgIHZhbHVlOiBOdW1iZXJcclxuICB9LFxyXG5cclxuICBkYXRhICgpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGlucHV0VmFsdWU6IHRoaXMudmFsdWUsXHJcbiAgICAgIGlzRHJhZ2dpbmc6IGZhbHNlLFxyXG4gICAgICB2YWx1ZU9uTW91c2VEb3duOiBudWxsIGFzIG51bWJlciB8IG51bGwsXHJcbiAgICAgIHZhbHVlT25Nb3VzZVVwOiBudWxsIGFzIG51bWJlciB8IG51bGxcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBjb21wdXRlZDoge1xyXG4gICAgY291bnQgKCk6IG51bWJlciB7XHJcbiAgICAgIHJldHVybiB0aGlzLm1heCAtIHRoaXMubWluICsgMVxyXG4gICAgfSxcclxuICAgIGRlZ3JlZXNQZXJVbml0ICgpOiBudW1iZXIge1xyXG4gICAgICByZXR1cm4gMzYwIC8gdGhpcy5yb3VuZENvdW50XHJcbiAgICB9LFxyXG4gICAgZGVncmVlcyAoKTogbnVtYmVyIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZGVncmVlc1BlclVuaXQgKiBNYXRoLlBJIC8gMTgwXHJcbiAgICB9LFxyXG4gICAgZGlzcGxheWVkVmFsdWUgKCk6IG51bWJlciB7XHJcbiAgICAgIHJldHVybiB0aGlzLnZhbHVlID09IG51bGwgPyB0aGlzLm1pbiA6IHRoaXMudmFsdWVcclxuICAgIH0sXHJcbiAgICBpbm5lclJhZGl1c1NjYWxlICgpOiBudW1iZXIge1xyXG4gICAgICByZXR1cm4gMC42MlxyXG4gICAgfSxcclxuICAgIHJvdW5kQ291bnQgKCk6IG51bWJlciB7XHJcbiAgICAgIHJldHVybiB0aGlzLmRvdWJsZSA/ICh0aGlzLmNvdW50IC8gMikgOiB0aGlzLmNvdW50XHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgd2F0Y2g6IHtcclxuICAgIHZhbHVlICh2YWx1ZSkge1xyXG4gICAgICB0aGlzLmlucHV0VmFsdWUgPSB2YWx1ZVxyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIG1ldGhvZHM6IHtcclxuICAgIHdoZWVsIChlOiBNb3VzZVdoZWVsRXZlbnQpIHtcclxuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpXHJcblxyXG4gICAgICBjb25zdCBkZWx0YSA9IE1hdGguc2lnbihlLndoZWVsRGVsdGEgfHwgMSlcclxuICAgICAgbGV0IHZhbHVlID0gdGhpcy5kaXNwbGF5ZWRWYWx1ZVxyXG4gICAgICBkbyB7XHJcbiAgICAgICAgdmFsdWUgPSB2YWx1ZSArIGRlbHRhXHJcbiAgICAgICAgdmFsdWUgPSAodmFsdWUgLSB0aGlzLm1pbiArIHRoaXMuY291bnQpICUgdGhpcy5jb3VudCArIHRoaXMubWluXHJcbiAgICAgIH0gd2hpbGUgKCF0aGlzLmlzQWxsb3dlZCh2YWx1ZSkgJiYgdmFsdWUgIT09IHRoaXMuZGlzcGxheWVkVmFsdWUpXHJcblxyXG4gICAgICBpZiAodmFsdWUgIT09IHRoaXMuZGlzcGxheWVkVmFsdWUpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZSh2YWx1ZSlcclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIGlzSW5uZXIgKHZhbHVlOiBudW1iZXIpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZG91YmxlICYmICh2YWx1ZSAtIHRoaXMubWluID49IHRoaXMucm91bmRDb3VudClcclxuICAgIH0sXHJcbiAgICBoYW5kU2NhbGUgKHZhbHVlOiBudW1iZXIpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuaXNJbm5lcih2YWx1ZSkgPyB0aGlzLmlubmVyUmFkaXVzU2NhbGUgOiAxXHJcbiAgICB9LFxyXG4gICAgaXNBbGxvd2VkICh2YWx1ZTogbnVtYmVyKSB7XHJcbiAgICAgIHJldHVybiAhdGhpcy5hbGxvd2VkVmFsdWVzIHx8IHRoaXMuYWxsb3dlZFZhbHVlcyh2YWx1ZSlcclxuICAgIH0sXHJcbiAgICBnZW5WYWx1ZXMgKCkge1xyXG4gICAgICBjb25zdCBjaGlsZHJlbjogVk5vZGVbXSA9IFtdXHJcblxyXG4gICAgICBmb3IgKGxldCB2YWx1ZSA9IHRoaXMubWluOyB2YWx1ZSA8PSB0aGlzLm1heDsgdmFsdWUgPSB2YWx1ZSArIHRoaXMuc3RlcCkge1xyXG4gICAgICAgIGNvbnN0IGNvbG9yID0gdmFsdWUgPT09IHRoaXMudmFsdWUgJiYgKHRoaXMuY29sb3IgfHwgJ2FjY2VudCcpXHJcbiAgICAgICAgY2hpbGRyZW4ucHVzaCh0aGlzLiRjcmVhdGVFbGVtZW50KCdzcGFuJywgdGhpcy5zZXRCYWNrZ3JvdW5kQ29sb3IoY29sb3IsIHtcclxuICAgICAgICAgIHN0YXRpY0NsYXNzOiAndi10aW1lLXBpY2tlci1jbG9ja19faXRlbScsXHJcbiAgICAgICAgICAnY2xhc3MnOiB7XHJcbiAgICAgICAgICAgICd2LXRpbWUtcGlja2VyLWNsb2NrX19pdGVtLS1hY3RpdmUnOiB2YWx1ZSA9PT0gdGhpcy5kaXNwbGF5ZWRWYWx1ZSxcclxuICAgICAgICAgICAgJ3YtdGltZS1waWNrZXItY2xvY2tfX2l0ZW0tLWRpc2FibGVkJzogdGhpcy5kaXNhYmxlZCB8fCAhdGhpcy5pc0FsbG93ZWQodmFsdWUpXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgc3R5bGU6IHRoaXMuZ2V0VHJhbnNmb3JtKHZhbHVlKSxcclxuICAgICAgICAgIGRvbVByb3BzOiB7IGlubmVySFRNTDogYDxzcGFuPiR7dGhpcy5mb3JtYXQodmFsdWUpfTwvc3Bhbj5gIH1cclxuICAgICAgICB9KSkpXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiBjaGlsZHJlblxyXG4gICAgfSxcclxuICAgIGdlbkhhbmQgKCkge1xyXG4gICAgICBjb25zdCBzY2FsZSA9IGBzY2FsZVkoJHt0aGlzLmhhbmRTY2FsZSh0aGlzLmRpc3BsYXllZFZhbHVlKX0pYFxyXG4gICAgICBjb25zdCBhbmdsZSA9IHRoaXMucm90YXRlICsgdGhpcy5kZWdyZWVzUGVyVW5pdCAqICh0aGlzLmRpc3BsYXllZFZhbHVlIC0gdGhpcy5taW4pXHJcbiAgICAgIGNvbnN0IGNvbG9yID0gKHRoaXMudmFsdWUgIT0gbnVsbCkgJiYgKHRoaXMuY29sb3IgfHwgJ2FjY2VudCcpXHJcbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCdkaXYnLCB0aGlzLnNldEJhY2tncm91bmRDb2xvcihjb2xvciwge1xyXG4gICAgICAgIHN0YXRpY0NsYXNzOiAndi10aW1lLXBpY2tlci1jbG9ja19faGFuZCcsXHJcbiAgICAgICAgJ2NsYXNzJzoge1xyXG4gICAgICAgICAgJ3YtdGltZS1waWNrZXItY2xvY2tfX2hhbmQtLWlubmVyJzogdGhpcy5pc0lubmVyKHRoaXMudmFsdWUpXHJcbiAgICAgICAgfSxcclxuICAgICAgICBzdHlsZToge1xyXG4gICAgICAgICAgdHJhbnNmb3JtOiBgcm90YXRlKCR7YW5nbGV9ZGVnKSAke3NjYWxlfWBcclxuICAgICAgICB9XHJcbiAgICAgIH0pKVxyXG4gICAgfSxcclxuICAgIGdldFRyYW5zZm9ybSAoaTogbnVtYmVyKSB7XHJcbiAgICAgIGNvbnN0IHsgeCwgeSB9ID0gdGhpcy5nZXRQb3NpdGlvbihpKVxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGxlZnQ6IGAkezUwICsgeCAqIDUwfSVgLFxyXG4gICAgICAgIHRvcDogYCR7NTAgKyB5ICogNTB9JWBcclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIGdldFBvc2l0aW9uICh2YWx1ZTogbnVtYmVyKSB7XHJcbiAgICAgIGNvbnN0IHJvdGF0ZVJhZGlhbnMgPSB0aGlzLnJvdGF0ZSAqIE1hdGguUEkgLyAxODBcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICB4OiBNYXRoLnNpbigodmFsdWUgLSB0aGlzLm1pbikgKiB0aGlzLmRlZ3JlZXMgKyByb3RhdGVSYWRpYW5zKSAqIHRoaXMuaGFuZFNjYWxlKHZhbHVlKSxcclxuICAgICAgICB5OiAtTWF0aC5jb3MoKHZhbHVlIC0gdGhpcy5taW4pICogdGhpcy5kZWdyZWVzICsgcm90YXRlUmFkaWFucykgKiB0aGlzLmhhbmRTY2FsZSh2YWx1ZSlcclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIG9uTW91c2VEb3duIChlOiBNb3VzZUV2ZW50IHwgVG91Y2hFdmVudCkge1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KClcclxuXHJcbiAgICAgIHRoaXMudmFsdWVPbk1vdXNlRG93biA9IG51bGxcclxuICAgICAgdGhpcy52YWx1ZU9uTW91c2VVcCA9IG51bGxcclxuICAgICAgdGhpcy5pc0RyYWdnaW5nID0gdHJ1ZVxyXG4gICAgICB0aGlzLm9uRHJhZ01vdmUoZSlcclxuICAgIH0sXHJcbiAgICBvbk1vdXNlVXAgKCkge1xyXG4gICAgICB0aGlzLmlzRHJhZ2dpbmcgPSBmYWxzZVxyXG4gICAgICBpZiAodGhpcy52YWx1ZU9uTW91c2VVcCAhPT0gbnVsbCAmJiB0aGlzLmlzQWxsb3dlZCh0aGlzLnZhbHVlT25Nb3VzZVVwKSkge1xyXG4gICAgICAgIHRoaXMuJGVtaXQoJ2NoYW5nZScsIHRoaXMudmFsdWVPbk1vdXNlVXApXHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICBvbkRyYWdNb3ZlIChlOiBNb3VzZUV2ZW50IHwgVG91Y2hFdmVudCkge1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KClcclxuICAgICAgaWYgKCF0aGlzLmlzRHJhZ2dpbmcgJiYgZS50eXBlICE9PSAnY2xpY2snKSByZXR1cm5cclxuXHJcbiAgICAgIGNvbnN0IHsgd2lkdGgsIHRvcCwgbGVmdCB9ID0gdGhpcy4kcmVmcy5jbG9jay5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxyXG4gICAgICBjb25zdCB7IHdpZHRoOiBpbm5lcldpZHRoIH0gPSB0aGlzLiRyZWZzLmlubmVyQ2xvY2suZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcclxuICAgICAgY29uc3QgeyBjbGllbnRYLCBjbGllbnRZIH0gPSAndG91Y2hlcycgaW4gZSA/IGUudG91Y2hlc1swXSA6IGVcclxuICAgICAgY29uc3QgY2VudGVyID0geyB4OiB3aWR0aCAvIDIsIHk6IC13aWR0aCAvIDIgfVxyXG4gICAgICBjb25zdCBjb29yZHMgPSB7IHg6IGNsaWVudFggLSBsZWZ0LCB5OiB0b3AgLSBjbGllbnRZIH1cclxuICAgICAgY29uc3QgaGFuZEFuZ2xlID0gTWF0aC5yb3VuZCh0aGlzLmFuZ2xlKGNlbnRlciwgY29vcmRzKSAtIHRoaXMucm90YXRlICsgMzYwKSAlIDM2MFxyXG4gICAgICBjb25zdCBpbnNpZGVDbGljayA9IHRoaXMuZG91YmxlICYmIHRoaXMuZXVjbGlkZWFuKGNlbnRlciwgY29vcmRzKSA8IChpbm5lcldpZHRoICsgaW5uZXJXaWR0aCAqIHRoaXMuaW5uZXJSYWRpdXNTY2FsZSkgLyA0XHJcbiAgICAgIGNvbnN0IHZhbHVlID0gTWF0aC5yb3VuZChoYW5kQW5nbGUgLyB0aGlzLmRlZ3JlZXNQZXJVbml0KSArXHJcbiAgICAgICAgdGhpcy5taW4gKyAoaW5zaWRlQ2xpY2sgPyB0aGlzLnJvdW5kQ291bnQgOiAwKVxyXG5cclxuICAgICAgLy8gTmVjZXNzYXJ5IHRvIGZpeCBlZGdlIGNhc2Ugd2hlbiBzZWxlY3RpbmcgbGVmdCBwYXJ0IG9mIHRoZSB2YWx1ZShzKSBhdCAxMiBvJ2Nsb2NrXHJcbiAgICAgIGxldCBuZXdWYWx1ZTogbnVtYmVyXHJcbiAgICAgIGlmIChoYW5kQW5nbGUgPj0gKDM2MCAtIHRoaXMuZGVncmVlc1BlclVuaXQgLyAyKSkge1xyXG4gICAgICAgIG5ld1ZhbHVlID0gaW5zaWRlQ2xpY2sgPyB0aGlzLm1heCAtIHRoaXMucm91bmRDb3VudCArIDEgOiB0aGlzLm1pblxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG5ld1ZhbHVlID0gdmFsdWVcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHRoaXMuaXNBbGxvd2VkKHZhbHVlKSkge1xyXG4gICAgICAgIGlmICh0aGlzLnZhbHVlT25Nb3VzZURvd24gPT09IG51bGwpIHtcclxuICAgICAgICAgIHRoaXMudmFsdWVPbk1vdXNlRG93biA9IG5ld1ZhbHVlXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudmFsdWVPbk1vdXNlVXAgPSBuZXdWYWx1ZVxyXG4gICAgICAgIHRoaXMudXBkYXRlKG5ld1ZhbHVlKVxyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgdXBkYXRlICh2YWx1ZTogbnVtYmVyKSB7XHJcbiAgICAgIGlmICh0aGlzLmlucHV0VmFsdWUgIT09IHZhbHVlKSB7XHJcbiAgICAgICAgdGhpcy5pbnB1dFZhbHVlID0gdmFsdWVcclxuICAgICAgICB0aGlzLiRlbWl0KCdpbnB1dCcsIHZhbHVlKVxyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgZXVjbGlkZWFuIChwMDogUG9pbnQsIHAxOiBQb2ludCkge1xyXG4gICAgICBjb25zdCBkeCA9IHAxLnggLSBwMC54XHJcbiAgICAgIGNvbnN0IGR5ID0gcDEueSAtIHAwLnlcclxuXHJcbiAgICAgIHJldHVybiBNYXRoLnNxcnQoZHggKiBkeCArIGR5ICogZHkpXHJcbiAgICB9LFxyXG4gICAgYW5nbGUgKGNlbnRlcjogUG9pbnQsIHAxOiBQb2ludCkge1xyXG4gICAgICBjb25zdCB2YWx1ZSA9IDIgKiBNYXRoLmF0YW4yKHAxLnkgLSBjZW50ZXIueSAtIHRoaXMuZXVjbGlkZWFuKGNlbnRlciwgcDEpLCBwMS54IC0gY2VudGVyLngpXHJcbiAgICAgIHJldHVybiBNYXRoLmFicyh2YWx1ZSAqIDE4MCAvIE1hdGguUEkpXHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgcmVuZGVyIChoKTogVk5vZGUge1xyXG4gICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAgc3RhdGljQ2xhc3M6ICd2LXRpbWUtcGlja2VyLWNsb2NrJyxcclxuICAgICAgY2xhc3M6IHtcclxuICAgICAgICAndi10aW1lLXBpY2tlci1jbG9jay0taW5kZXRlcm1pbmF0ZSc6IHRoaXMudmFsdWUgPT0gbnVsbCxcclxuICAgICAgICAuLi50aGlzLnRoZW1lQ2xhc3Nlc1xyXG4gICAgICB9LFxyXG4gICAgICBvbjogKHRoaXMucmVhZG9ubHkgfHwgdGhpcy5kaXNhYmxlZCkgPyB1bmRlZmluZWQgOiBPYmplY3QuYXNzaWduKHtcclxuICAgICAgICBtb3VzZWRvd246IHRoaXMub25Nb3VzZURvd24sXHJcbiAgICAgICAgbW91c2V1cDogdGhpcy5vbk1vdXNlVXAsXHJcbiAgICAgICAgbW91c2VsZWF2ZTogKCkgPT4gKHRoaXMuaXNEcmFnZ2luZyAmJiB0aGlzLm9uTW91c2VVcCgpKSxcclxuICAgICAgICB0b3VjaHN0YXJ0OiB0aGlzLm9uTW91c2VEb3duLFxyXG4gICAgICAgIHRvdWNoZW5kOiB0aGlzLm9uTW91c2VVcCxcclxuICAgICAgICBtb3VzZW1vdmU6IHRoaXMub25EcmFnTW92ZSxcclxuICAgICAgICB0b3VjaG1vdmU6IHRoaXMub25EcmFnTW92ZVxyXG4gICAgICB9LCB0aGlzLnNjcm9sbGFibGUgPyB7XHJcbiAgICAgICAgd2hlZWw6IHRoaXMud2hlZWxcclxuICAgICAgfSA6IHt9KSxcclxuICAgICAgcmVmOiAnY2xvY2snXHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGgoJ2RpdicsIGRhdGEsIFtcclxuICAgICAgaCgnZGl2Jywge1xyXG4gICAgICAgIHN0YXRpY0NsYXNzOiAndi10aW1lLXBpY2tlci1jbG9ja19faW5uZXInLFxyXG4gICAgICAgIHJlZjogJ2lubmVyQ2xvY2snXHJcbiAgICAgIH0sIFtcclxuICAgICAgICB0aGlzLmdlbkhhbmQoKSxcclxuICAgICAgICB0aGlzLmdlblZhbHVlcygpXHJcbiAgICAgIF0pXHJcbiAgICBdKVxyXG4gIH1cclxufSlcclxuIl19