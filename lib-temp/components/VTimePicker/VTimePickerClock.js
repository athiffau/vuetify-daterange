import '../../stylus/components/_time-picker-clock.styl';
// Mixins
import Colorable from '../../mixins/colorable';
import Themeable from '../../mixins/themeable';
import mixins from '../../util/mixins';
export default mixins(Colorable, Themeable
/* @vue/component */
).extend({
    name: 'v-time-picker-clock',
    props: {
        allowedValues: Function,
        disabled: Boolean,
        double: Boolean,
        format: {
            type: Function,
            default: (val) => val
        },
        max: {
            type: Number,
            required: true
        },
        min: {
            type: Number,
            required: true
        },
        scrollable: Boolean,
        readonly: Boolean,
        rotate: {
            type: Number,
            default: 0
        },
        step: {
            type: Number,
            default: 1
        },
        value: Number
    },
    data() {
        return {
            inputValue: this.value,
            isDragging: false,
            valueOnMouseDown: null,
            valueOnMouseUp: null
        };
    },
    computed: {
        count() {
            return this.max - this.min + 1;
        },
        degreesPerUnit() {
            return 360 / this.roundCount;
        },
        degrees() {
            return this.degreesPerUnit * Math.PI / 180;
        },
        displayedValue() {
            return this.value == null ? this.min : this.value;
        },
        innerRadiusScale() {
            return 0.62;
        },
        roundCount() {
            return this.double ? (this.count / 2) : this.count;
        }
    },
    watch: {
        value(value) {
            this.inputValue = value;
        }
    },
    methods: {
        wheel(e) {
            e.preventDefault();
            const delta = Math.sign(-e.deltaY || 1);
            let value = this.displayedValue;
            do {
                value = value + delta;
                value = (value - this.min + this.count) % this.count + this.min;
            } while (!this.isAllowed(value) && value !== this.displayedValue);
            if (value !== this.displayedValue) {
                this.update(value);
            }
        },
        isInner(value) {
            return this.double && (value - this.min >= this.roundCount);
        },
        handScale(value) {
            return this.isInner(value) ? this.innerRadiusScale : 1;
        },
        isAllowed(value) {
            return !this.allowedValues || this.allowedValues(value);
        },
        genValues() {
            const children = [];
            for (let value = this.min; value <= this.max; value = value + this.step) {
                const color = value === this.value && (this.color || 'accent');
                children.push(this.$createElement('span', this.setBackgroundColor(color, {
                    staticClass: 'v-time-picker-clock__item',
                    'class': {
                        'v-time-picker-clock__item--active': value === this.displayedValue,
                        'v-time-picker-clock__item--disabled': this.disabled || !this.isAllowed(value)
                    },
                    style: this.getTransform(value),
                    domProps: { innerHTML: `<span>${this.format(value)}</span>` }
                })));
            }
            return children;
        },
        genHand() {
            const scale = `scaleY(${this.handScale(this.displayedValue)})`;
            const angle = this.rotate + this.degreesPerUnit * (this.displayedValue - this.min);
            const color = (this.value != null) && (this.color || 'accent');
            return this.$createElement('div', this.setBackgroundColor(color, {
                staticClass: 'v-time-picker-clock__hand',
                'class': {
                    'v-time-picker-clock__hand--inner': this.isInner(this.value)
                },
                style: {
                    transform: `rotate(${angle}deg) ${scale}`
                }
            }));
        },
        getTransform(i) {
            const { x, y } = this.getPosition(i);
            return {
                left: `${50 + x * 50}%`,
                top: `${50 + y * 50}%`
            };
        },
        getPosition(value) {
            const rotateRadians = this.rotate * Math.PI / 180;
            return {
                x: Math.sin((value - this.min) * this.degrees + rotateRadians) * this.handScale(value),
                y: -Math.cos((value - this.min) * this.degrees + rotateRadians) * this.handScale(value)
            };
        },
        onMouseDown(e) {
            e.preventDefault();
            this.valueOnMouseDown = null;
            this.valueOnMouseUp = null;
            this.isDragging = true;
            this.onDragMove(e);
        },
        onMouseUp() {
            this.isDragging = false;
            if (this.valueOnMouseUp !== null && this.isAllowed(this.valueOnMouseUp)) {
                this.$emit('change', this.valueOnMouseUp);
            }
        },
        onDragMove(e) {
            e.preventDefault();
            if (!this.isDragging && e.type !== 'click')
                return;
            const { width, top, left } = this.$refs.clock.getBoundingClientRect();
            const { width: innerWidth } = this.$refs.innerClock.getBoundingClientRect();
            const { clientX, clientY } = 'touches' in e ? e.touches[0] : e;
            const center = { x: width / 2, y: -width / 2 };
            const coords = { x: clientX - left, y: top - clientY };
            const handAngle = Math.round(this.angle(center, coords) - this.rotate + 360) % 360;
            const insideClick = this.double && this.euclidean(center, coords) < (innerWidth + innerWidth * this.innerRadiusScale) / 4;
            const value = Math.round(handAngle / this.degreesPerUnit) +
                this.min + (insideClick ? this.roundCount : 0);
            // Necessary to fix edge case when selecting left part of the value(s) at 12 o'clock
            let newValue;
            if (handAngle >= (360 - this.degreesPerUnit / 2)) {
                newValue = insideClick ? this.max - this.roundCount + 1 : this.min;
            }
            else {
                newValue = value;
            }
            if (this.isAllowed(value)) {
                if (this.valueOnMouseDown === null) {
                    this.valueOnMouseDown = newValue;
                }
                this.valueOnMouseUp = newValue;
                this.update(newValue);
            }
        },
        update(value) {
            if (this.inputValue !== value) {
                this.inputValue = value;
                this.$emit('input', value);
            }
        },
        euclidean(p0, p1) {
            const dx = p1.x - p0.x;
            const dy = p1.y - p0.y;
            return Math.sqrt(dx * dx + dy * dy);
        },
        angle(center, p1) {
            const value = 2 * Math.atan2(p1.y - center.y - this.euclidean(center, p1), p1.x - center.x);
            return Math.abs(value * 180 / Math.PI);
        }
    },
    render(h) {
        const data = {
            staticClass: 'v-time-picker-clock',
            class: {
                'v-time-picker-clock--indeterminate': this.value == null,
                ...this.themeClasses
            },
            on: (this.readonly || this.disabled) ? undefined : Object.assign({
                mousedown: this.onMouseDown,
                mouseup: this.onMouseUp,
                mouseleave: () => (this.isDragging && this.onMouseUp()),
                touchstart: this.onMouseDown,
                touchend: this.onMouseUp,
                mousemove: this.onDragMove,
                touchmove: this.onDragMove
            }, this.scrollable ? {
                wheel: this.wheel
            } : {}),
            ref: 'clock'
        };
        return h('div', data, [
            h('div', {
                staticClass: 'v-time-picker-clock__inner',
                ref: 'innerClock'
            }, [
                this.genHand(),
                this.genValues()
            ])
        ]);
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlRpbWVQaWNrZXJDbG9jay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZUaW1lUGlja2VyL1ZUaW1lUGlja2VyQ2xvY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxpREFBaUQsQ0FBQTtBQUV4RCxTQUFTO0FBQ1QsT0FBTyxTQUFTLE1BQU0sd0JBQXdCLENBQUE7QUFDOUMsT0FBTyxTQUFTLE1BQU0sd0JBQXdCLENBQUE7QUFDOUMsT0FBTyxNQUFzQixNQUFNLG1CQUFtQixDQUFBO0FBZXRELGVBQWUsTUFBTSxDQVFuQixTQUFTLEVBQ1QsU0FBUztBQUNYLG9CQUFvQjtDQUNuQixDQUFDLE1BQU0sQ0FBQztJQUNQLElBQUksRUFBRSxxQkFBcUI7SUFFM0IsS0FBSyxFQUFFO1FBQ0wsYUFBYSxFQUFFLFFBQVE7UUFDdkIsUUFBUSxFQUFFLE9BQU87UUFDakIsTUFBTSxFQUFFLE9BQU87UUFDZixNQUFNLEVBQUU7WUFDTixJQUFJLEVBQUUsUUFBUTtZQUNkLE9BQU8sRUFBRSxDQUFDLEdBQW9CLEVBQUUsRUFBRSxDQUFDLEdBQUc7U0FDdkM7UUFDRCxHQUFHLEVBQUU7WUFDSCxJQUFJLEVBQUUsTUFBTTtZQUNaLFFBQVEsRUFBRSxJQUFJO1NBQ2Y7UUFDRCxHQUFHLEVBQUU7WUFDSCxJQUFJLEVBQUUsTUFBTTtZQUNaLFFBQVEsRUFBRSxJQUFJO1NBQ2Y7UUFDRCxVQUFVLEVBQUUsT0FBTztRQUNuQixRQUFRLEVBQUUsT0FBTztRQUNqQixNQUFNLEVBQUU7WUFDTixJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxJQUFJLEVBQUU7WUFDSixJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxLQUFLLEVBQUUsTUFBTTtLQUNkO0lBRUQsSUFBSTtRQUNGLE9BQU87WUFDTCxVQUFVLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFD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LElBQUksSUFBSTtnQkFDeEQsR0FBRyxJQUFJLENBQUMsWUFBWTthQUNyQjtZQUNELEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7Z0JBQy9ELFNBQVMsRUFBRSxJQUFJLENBQUMsV0FBVztnQkFDM0IsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTO2dCQUN2QixVQUFVLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDdkQsVUFBVSxFQUFFLElBQUksQ0FBQyxXQUFXO2dCQUM1QixRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVM7Z0JBQ3hCLFNBQVMsRUFBRSxJQUFJLENBQUMsVUFBVTtnQkFDMUIsU0FBUyxFQUFFLElBQUksQ0FBQyxVQUFVO2FBQzNCLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQ25CLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSzthQUNsQixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDUCxHQUFHLEVBQUUsT0FBTztTQUNiLENBQUE7UUFFRCxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFO1lBQ3BCLENBQUMsQ0FBQyxLQUFLLEVBQUU7Z0JBQ1AsV0FBVyxFQUFFLDRCQUE0QjtnQkFDekMsR0FBRyxFQUFFLFlBQVk7YUFDbEIsRUFBRTtnQkFDRCxJQUFJLENBQUMsT0FBTyxFQUFFO2dCQUNkLElBQUksQ0FBQyxTQUFTLEVBQUU7YUFDakIsQ0FBQztTQUNILENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJy4uLy4uL3N0eWx1cy9jb21wb25lbnRzL190aW1lLXBpY2tlci1jbG9jay5zdHlsJ1xyXG5cclxuLy8gTWl4aW5zXHJcbmltcG9ydCBDb2xvcmFibGUgZnJvbSAnLi4vLi4vbWl4aW5zL2NvbG9yYWJsZSdcclxuaW1wb3J0IFRoZW1lYWJsZSBmcm9tICcuLi8uLi9taXhpbnMvdGhlbWVhYmxlJ1xyXG5pbXBvcnQgbWl4aW5zLCB7IEV4dHJhY3RWdWUgfSBmcm9tICcuLi8uLi91dGlsL21peGlucydcclxuaW1wb3J0IFZ1ZSwgeyBWTm9kZSB9IGZyb20gJ3Z1ZSdcclxuXHJcbmludGVyZmFjZSBQb2ludCB7XHJcbiAgeDogbnVtYmVyXHJcbiAgeTogbnVtYmVyXHJcbn1cclxuXHJcbmludGVyZmFjZSBvcHRpb25zIGV4dGVuZHMgVnVlIHtcclxuICAkcmVmczoge1xyXG4gICAgY2xvY2s6IEhUTUxFbGVtZW50XHJcbiAgICBpbm5lckNsb2NrOiBIVE1MRWxlbWVudFxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgbWl4aW5zPG9wdGlvbnMgJlxyXG4vKiBlc2xpbnQtZGlzYWJsZSBpbmRlbnQgKi9cclxuICBFeHRyYWN0VnVlPFtcclxuICAgIHR5cGVvZiBDb2xvcmFibGUsXHJcbiAgICB0eXBlb2YgVGhlbWVhYmxlXHJcbiAgXT5cclxuLyogZXNsaW50LWVuYWJsZSBpbmRlbnQgKi9cclxuPihcclxuICBDb2xvcmFibGUsXHJcbiAgVGhlbWVhYmxlXHJcbi8qIEB2dWUvY29tcG9uZW50ICovXHJcbikuZXh0ZW5kKHtcclxuICBuYW1lOiAndi10aW1lLXBpY2tlci1jbG9jaycsXHJcblxyXG4gIHByb3BzOiB7XHJcbiAgICBhbGxvd2VkVmFsdWVzOiBGdW5jdGlvbixcclxuICAgIGRpc2FibGVkOiBCb29sZWFuLFxyXG4gICAgZG91YmxlOiBCb29sZWFuLFxyXG4gICAgZm9ybWF0OiB7XHJcbiAgICAgIHR5cGU6IEZ1bmN0aW9uLFxyXG4gICAgICBkZWZhdWx0OiAodmFsOiBzdHJpbmcgfCBudW1iZXIpID0+IHZhbFxyXG4gICAgfSxcclxuICAgIG1heDoge1xyXG4gICAgICB0eXBlOiBOdW1iZXIsXHJcbiAgICAgIHJlcXVpcmVkOiB0cnVlXHJcbiAgICB9LFxyXG4gICAgbWluOiB7XHJcbiAgICAgIHR5cGU6IE51bWJlcixcclxuICAgICAgcmVxdWlyZWQ6IHRydWVcclxuICAgIH0sXHJcbiAgICBzY3JvbGxhYmxlOiBCb29sZWFuLFxyXG4gICAgcmVhZG9ubHk6IEJvb2xlYW4sXHJcbiAgICByb3RhdGU6IHtcclxuICAgICAgdHlwZTogTnVtYmVyLFxyXG4gICAgICBkZWZhdWx0OiAwXHJcbiAgICB9LFxyXG4gICAgc3RlcDoge1xyXG4gICAgICB0eXBlOiBOdW1iZXIsXHJcbiAgICAgIGRlZmF1bHQ6IDFcclxuICAgIH0sXHJcbiAgICB2YWx1ZTogTnVtYmVyXHJcbiAgfSxcclxuXHJcbiAgZGF0YSAoKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBpbnB1dFZhbHVlOiB0aGlzLnZhbHVlLFxyXG4gICAgICBpc0RyYWdnaW5nOiBmYWxzZSxcclxuICAgICAgdmFsdWVPbk1vdXNlRG93bjogbnVsbCBhcyBudW1iZXIgfCBudWxsLFxyXG4gICAgICB2YWx1ZU9uTW91c2VVcDogbnVsbCBhcyBudW1iZXIgfCBudWxsXHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgY29tcHV0ZWQ6IHtcclxuICAgIGNvdW50ICgpOiBudW1iZXIge1xyXG4gICAgICByZXR1cm4gdGhpcy5tYXggLSB0aGlzLm1pbiArIDFcclxuICAgIH0sXHJcbiAgICBkZWdyZWVzUGVyVW5pdCAoKTogbnVtYmVyIHtcclxuICAgICAgcmV0dXJuIDM2MCAvIHRoaXMucm91bmRDb3VudFxyXG4gICAgfSxcclxuICAgIGRlZ3JlZXMgKCk6IG51bWJlciB7XHJcbiAgICAgIHJldHVybiB0aGlzLmRlZ3JlZXNQZXJVbml0ICogTWF0aC5QSSAvIDE4MFxyXG4gICAgfSxcclxuICAgIGRpc3BsYXllZFZhbHVlICgpOiBudW1iZXIge1xyXG4gICAgICByZXR1cm4gdGhpcy52YWx1ZSA9PSBudWxsID8gdGhpcy5taW4gOiB0aGlzLnZhbHVlXHJcbiAgICB9LFxyXG4gICAgaW5uZXJSYWRpdXNTY2FsZSAoKTogbnVtYmVyIHtcclxuICAgICAgcmV0dXJuIDAuNjJcclxuICAgIH0sXHJcbiAgICByb3VuZENvdW50ICgpOiBudW1iZXIge1xyXG4gICAgICByZXR1cm4gdGhpcy5kb3VibGUgPyAodGhpcy5jb3VudCAvIDIpIDogdGhpcy5jb3VudFxyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIHdhdGNoOiB7XHJcbiAgICB2YWx1ZSAodmFsdWUpIHtcclxuICAgICAgdGhpcy5pbnB1dFZhbHVlID0gdmFsdWVcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBtZXRob2RzOiB7XHJcbiAgICB3aGVlbCAoZTogV2hlZWxFdmVudCkge1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KClcclxuXHJcbiAgICAgIGNvbnN0IGRlbHRhID0gTWF0aC5zaWduKC1lLmRlbHRhWSB8fCAxKVxyXG4gICAgICBsZXQgdmFsdWUgPSB0aGlzLmRpc3BsYXllZFZhbHVlXHJcbiAgICAgIGRvIHtcclxuICAgICAgICB2YWx1ZSA9IHZhbHVlICsgZGVsdGFcclxuICAgICAgICB2YWx1ZSA9ICh2YWx1ZSAtIHRoaXMubWluICsgdGhpcy5jb3VudCkgJSB0aGlzLmNvdW50ICsgdGhpcy5taW5cclxuICAgICAgfSB3aGlsZSAoIXRoaXMuaXNBbGxvd2VkKHZhbHVlKSAmJiB2YWx1ZSAhPT0gdGhpcy5kaXNwbGF5ZWRWYWx1ZSlcclxuXHJcbiAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy5kaXNwbGF5ZWRWYWx1ZSkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlKHZhbHVlKVxyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgaXNJbm5lciAodmFsdWU6IG51bWJlcikge1xyXG4gICAgICByZXR1cm4gdGhpcy5kb3VibGUgJiYgKHZhbHVlIC0gdGhpcy5taW4gPj0gdGhpcy5yb3VuZENvdW50KVxyXG4gICAgfSxcclxuICAgIGhhbmRTY2FsZSAodmFsdWU6IG51bWJlcikge1xyXG4gICAgICByZXR1cm4gdGhpcy5pc0lubmVyKHZhbHVlKSA/IHRoaXMuaW5uZXJSYWRpdXNTY2FsZSA6IDFcclxuICAgIH0sXHJcbiAgICBpc0FsbG93ZWQgKHZhbHVlOiBudW1iZXIpIHtcclxuICAgICAgcmV0dXJuICF0aGlzLmFsbG93ZWRWYWx1ZXMgfHwgdGhpcy5hbGxvd2VkVmFsdWVzKHZhbHVlKVxyXG4gICAgfSxcclxuICAgIGdlblZhbHVlcyAoKSB7XHJcbiAgICAgIGNvbnN0IGNoaWxkcmVuOiBWTm9kZVtdID0gW11cclxuXHJcbiAgICAgIGZvciAobGV0IHZhbHVlID0gdGhpcy5taW47IHZhbHVlIDw9IHRoaXMubWF4OyB2YWx1ZSA9IHZhbHVlICsgdGhpcy5zdGVwKSB7XHJcbiAgICAgICAgY29uc3QgY29sb3IgPSB2YWx1ZSA9PT0gdGhpcy52YWx1ZSAmJiAodGhpcy5jb2xvciB8fCAnYWNjZW50JylcclxuICAgICAgICBjaGlsZHJlbi5wdXNoKHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3NwYW4nLCB0aGlzLnNldEJhY2tncm91bmRDb2xvcihjb2xvciwge1xyXG4gICAgICAgICAgc3RhdGljQ2xhc3M6ICd2LXRpbWUtcGlja2VyLWNsb2NrX19pdGVtJyxcclxuICAgICAgICAgICdjbGFzcyc6IHtcclxuICAgICAgICAgICAgJ3YtdGltZS1waWNrZXItY2xvY2tfX2l0ZW0tLWFjdGl2ZSc6IHZhbHVlID09PSB0aGlzLmRpc3BsYXllZFZhbHVlLFxyXG4gICAgICAgICAgICAndi10aW1lLXBpY2tlci1jbG9ja19faXRlbS0tZGlzYWJsZWQnOiB0aGlzLmRpc2FibGVkIHx8ICF0aGlzLmlzQWxsb3dlZCh2YWx1ZSlcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBzdHlsZTogdGhpcy5nZXRUcmFuc2Zvcm0odmFsdWUpLFxyXG4gICAgICAgICAgZG9tUHJvcHM6IHsgaW5uZXJIVE1MOiBgPHNwYW4+JHt0aGlzLmZvcm1hdCh2YWx1ZSl9PC9zcGFuPmAgfVxyXG4gICAgICAgIH0pKSlcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIGNoaWxkcmVuXHJcbiAgICB9LFxyXG4gICAgZ2VuSGFuZCAoKSB7XHJcbiAgICAgIGNvbnN0IHNjYWxlID0gYHNjYWxlWSgke3RoaXMuaGFuZFNjYWxlKHRoaXMuZGlzcGxheWVkVmFsdWUpfSlgXHJcbiAgICAgIGNvbnN0IGFuZ2xlID0gdGhpcy5yb3RhdGUgKyB0aGlzLmRlZ3JlZXNQZXJVbml0ICogKHRoaXMuZGlzcGxheWVkVmFsdWUgLSB0aGlzLm1pbilcclxuICAgICAgY29uc3QgY29sb3IgPSAodGhpcy52YWx1ZSAhPSBudWxsKSAmJiAodGhpcy5jb2xvciB8fCAnYWNjZW50JylcclxuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2RpdicsIHRoaXMuc2V0QmFja2dyb3VuZENvbG9yKGNvbG9yLCB7XHJcbiAgICAgICAgc3RhdGljQ2xhc3M6ICd2LXRpbWUtcGlja2VyLWNsb2NrX19oYW5kJyxcclxuICAgICAgICAnY2xhc3MnOiB7XHJcbiAgICAgICAgICAndi10aW1lLXBpY2tlci1jbG9ja19faGFuZC0taW5uZXInOiB0aGlzLmlzSW5uZXIodGhpcy52YWx1ZSlcclxuICAgICAgICB9LFxyXG4gICAgICAgIHN0eWxlOiB7XHJcbiAgICAgICAgICB0cmFuc2Zvcm06IGByb3RhdGUoJHthbmdsZX1kZWcpICR7c2NhbGV9YFxyXG4gICAgICAgIH1cclxuICAgICAgfSkpXHJcbiAgICB9LFxyXG4gICAgZ2V0VHJhbnNmb3JtIChpOiBudW1iZXIpIHtcclxuICAgICAgY29uc3QgeyB4LCB5IH0gPSB0aGlzLmdldFBvc2l0aW9uKGkpXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgbGVmdDogYCR7NTAgKyB4ICogNTB9JWAsXHJcbiAgICAgICAgdG9wOiBgJHs1MCArIHkgKiA1MH0lYFxyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgZ2V0UG9zaXRpb24gKHZhbHVlOiBudW1iZXIpIHtcclxuICAgICAgY29uc3Qgcm90YXRlUmFkaWFucyA9IHRoaXMucm90YXRlICogTWF0aC5QSSAvIDE4MFxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHg6IE1hdGguc2luKCh2YWx1ZSAtIHRoaXMubWluKSAqIHRoaXMuZGVncmVlcyArIHJvdGF0ZVJhZGlhbnMpICogdGhpcy5oYW5kU2NhbGUodmFsdWUpLFxyXG4gICAgICAgIHk6IC1NYXRoLmNvcygodmFsdWUgLSB0aGlzLm1pbikgKiB0aGlzLmRlZ3JlZXMgKyByb3RhdGVSYWRpYW5zKSAqIHRoaXMuaGFuZFNjYWxlKHZhbHVlKVxyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgb25Nb3VzZURvd24gKGU6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KSB7XHJcbiAgICAgIGUucHJldmVudERlZmF1bHQoKVxyXG5cclxuICAgICAgdGhpcy52YWx1ZU9uTW91c2VEb3duID0gbnVsbFxyXG4gICAgICB0aGlzLnZhbHVlT25Nb3VzZVVwID0gbnVsbFxyXG4gICAgICB0aGlzLmlzRHJhZ2dpbmcgPSB0cnVlXHJcbiAgICAgIHRoaXMub25EcmFnTW92ZShlKVxyXG4gICAgfSxcclxuICAgIG9uTW91c2VVcCAoKSB7XHJcbiAgICAgIHRoaXMuaXNEcmFnZ2luZyA9IGZhbHNlXHJcbiAgICAgIGlmICh0aGlzLnZhbHVlT25Nb3VzZVVwICE9PSBudWxsICYmIHRoaXMuaXNBbGxvd2VkKHRoaXMudmFsdWVPbk1vdXNlVXApKSB7XHJcbiAgICAgICAgdGhpcy4kZW1pdCgnY2hhbmdlJywgdGhpcy52YWx1ZU9uTW91c2VVcClcclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIG9uRHJhZ01vdmUgKGU6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KSB7XHJcbiAgICAgIGUucHJldmVudERlZmF1bHQoKVxyXG4gICAgICBpZiAoIXRoaXMuaXNEcmFnZ2luZyAmJiBlLnR5cGUgIT09ICdjbGljaycpIHJldHVyblxyXG5cclxuICAgICAgY29uc3QgeyB3aWR0aCwgdG9wLCBsZWZ0IH0gPSB0aGlzLiRyZWZzLmNsb2NrLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXHJcbiAgICAgIGNvbnN0IHsgd2lkdGg6IGlubmVyV2lkdGggfSA9IHRoaXMuJHJlZnMuaW5uZXJDbG9jay5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxyXG4gICAgICBjb25zdCB7IGNsaWVudFgsIGNsaWVudFkgfSA9ICd0b3VjaGVzJyBpbiBlID8gZS50b3VjaGVzWzBdIDogZVxyXG4gICAgICBjb25zdCBjZW50ZXIgPSB7IHg6IHdpZHRoIC8gMiwgeTogLXdpZHRoIC8gMiB9XHJcbiAgICAgIGNvbnN0IGNvb3JkcyA9IHsgeDogY2xpZW50WCAtIGxlZnQsIHk6IHRvcCAtIGNsaWVudFkgfVxyXG4gICAgICBjb25zdCBoYW5kQW5nbGUgPSBNYXRoLnJvdW5kKHRoaXMuYW5nbGUoY2VudGVyLCBjb29yZHMpIC0gdGhpcy5yb3RhdGUgKyAzNjApICUgMzYwXHJcbiAgICAgIGNvbnN0IGluc2lkZUNsaWNrID0gdGhpcy5kb3VibGUgJiYgdGhpcy5ldWNsaWRlYW4oY2VudGVyLCBjb29yZHMpIDwgKGlubmVyV2lkdGggKyBpbm5lcldpZHRoICogdGhpcy5pbm5lclJhZGl1c1NjYWxlKSAvIDRcclxuICAgICAgY29uc3QgdmFsdWUgPSBNYXRoLnJvdW5kKGhhbmRBbmdsZSAvIHRoaXMuZGVncmVlc1BlclVuaXQpICtcclxuICAgICAgICB0aGlzLm1pbiArIChpbnNpZGVDbGljayA/IHRoaXMucm91bmRDb3VudCA6IDApXHJcblxyXG4gICAgICAvLyBOZWNlc3NhcnkgdG8gZml4IGVkZ2UgY2FzZSB3aGVuIHNlbGVjdGluZyBsZWZ0IHBhcnQgb2YgdGhlIHZhbHVlKHMpIGF0IDEyIG8nY2xvY2tcclxuICAgICAgbGV0IG5ld1ZhbHVlOiBudW1iZXJcclxuICAgICAgaWYgKGhhbmRBbmdsZSA+PSAoMzYwIC0gdGhpcy5kZWdyZWVzUGVyVW5pdCAvIDIpKSB7XHJcbiAgICAgICAgbmV3VmFsdWUgPSBpbnNpZGVDbGljayA/IHRoaXMubWF4IC0gdGhpcy5yb3VuZENvdW50ICsgMSA6IHRoaXMubWluXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbmV3VmFsdWUgPSB2YWx1ZVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAodGhpcy5pc0FsbG93ZWQodmFsdWUpKSB7XHJcbiAgICAgICAgaWYgKHRoaXMudmFsdWVPbk1vdXNlRG93biA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgdGhpcy52YWx1ZU9uTW91c2VEb3duID0gbmV3VmFsdWVcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy52YWx1ZU9uTW91c2VVcCA9IG5ld1ZhbHVlXHJcbiAgICAgICAgdGhpcy51cGRhdGUobmV3VmFsdWUpXHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICB1cGRhdGUgKHZhbHVlOiBudW1iZXIpIHtcclxuICAgICAgaWYgKHRoaXMuaW5wdXRWYWx1ZSAhPT0gdmFsdWUpIHtcclxuICAgICAgICB0aGlzLmlucHV0VmFsdWUgPSB2YWx1ZVxyXG4gICAgICAgIHRoaXMuJGVtaXQoJ2lucHV0JywgdmFsdWUpXHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICBldWNsaWRlYW4gKHAwOiBQb2ludCwgcDE6IFBvaW50KSB7XHJcbiAgICAgIGNvbnN0IGR4ID0gcDEueCAtIHAwLnhcclxuICAgICAgY29uc3QgZHkgPSBwMS55IC0gcDAueVxyXG5cclxuICAgICAgcmV0dXJuIE1hdGguc3FydChkeCAqIGR4ICsgZHkgKiBkeSlcclxuICAgIH0sXHJcbiAgICBhbmdsZSAoY2VudGVyOiBQb2ludCwgcDE6IFBvaW50KSB7XHJcbiAgICAgIGNvbnN0IHZhbHVlID0gMiAqIE1hdGguYXRhbjIocDEueSAtIGNlbnRlci55IC0gdGhpcy5ldWNsaWRlYW4oY2VudGVyLCBwMSksIHAxLnggLSBjZW50ZXIueClcclxuICAgICAgcmV0dXJuIE1hdGguYWJzKHZhbHVlICogMTgwIC8gTWF0aC5QSSlcclxuICAgIH1cclxuICB9LFxyXG5cclxuICByZW5kZXIgKGgpOiBWTm9kZSB7XHJcbiAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICBzdGF0aWNDbGFzczogJ3YtdGltZS1waWNrZXItY2xvY2snLFxyXG4gICAgICBjbGFzczoge1xyXG4gICAgICAgICd2LXRpbWUtcGlja2VyLWNsb2NrLS1pbmRldGVybWluYXRlJzogdGhpcy52YWx1ZSA9PSBudWxsLFxyXG4gICAgICAgIC4uLnRoaXMudGhlbWVDbGFzc2VzXHJcbiAgICAgIH0sXHJcbiAgICAgIG9uOiAodGhpcy5yZWFkb25seSB8fCB0aGlzLmRpc2FibGVkKSA/IHVuZGVmaW5lZCA6IE9iamVjdC5hc3NpZ24oe1xyXG4gICAgICAgIG1vdXNlZG93bjogdGhpcy5vbk1vdXNlRG93bixcclxuICAgICAgICBtb3VzZXVwOiB0aGlzLm9uTW91c2VVcCxcclxuICAgICAgICBtb3VzZWxlYXZlOiAoKSA9PiAodGhpcy5pc0RyYWdnaW5nICYmIHRoaXMub25Nb3VzZVVwKCkpLFxyXG4gICAgICAgIHRvdWNoc3RhcnQ6IHRoaXMub25Nb3VzZURvd24sXHJcbiAgICAgICAgdG91Y2hlbmQ6IHRoaXMub25Nb3VzZVVwLFxyXG4gICAgICAgIG1vdXNlbW92ZTogdGhpcy5vbkRyYWdNb3ZlLFxyXG4gICAgICAgIHRvdWNobW92ZTogdGhpcy5vbkRyYWdNb3ZlXHJcbiAgICAgIH0sIHRoaXMuc2Nyb2xsYWJsZSA/IHtcclxuICAgICAgICB3aGVlbDogdGhpcy53aGVlbFxyXG4gICAgICB9IDoge30pLFxyXG4gICAgICByZWY6ICdjbG9jaydcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gaCgnZGl2JywgZGF0YSwgW1xyXG4gICAgICBoKCdkaXYnLCB7XHJcbiAgICAgICAgc3RhdGljQ2xhc3M6ICd2LXRpbWUtcGlja2VyLWNsb2NrX19pbm5lcicsXHJcbiAgICAgICAgcmVmOiAnaW5uZXJDbG9jaydcclxuICAgICAgfSwgW1xyXG4gICAgICAgIHRoaXMuZ2VuSGFuZCgpLFxyXG4gICAgICAgIHRoaXMuZ2VuVmFsdWVzKClcclxuICAgICAgXSlcclxuICAgIF0pXHJcbiAgfVxyXG59KVxyXG4iXX0=