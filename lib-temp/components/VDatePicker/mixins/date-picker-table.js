import '../../../stylus/components/_date-picker-table.styl';
// Directives
import Touch from '../../../directives/touch';
// Mixins
import Colorable from '../../../mixins/colorable';
import Themeable from '../../../mixins/themeable';
// Utils
import isDateAllowed from '../util/isDateAllowed';
import isDateInRange, { isDateInHoverRange, isHoverAfterStartDate, isHoverBeforeStartDate } from '../util/isDateInRange';
import mixins from '../../../util/mixins';
export default mixins(Colorable, Themeable
/* @vue/component */
).extend({
    directives: { Touch },
    props: {
        allowedDates: Function,
        current: String,
        disabled: Boolean,
        format: Function,
        events: {
            type: [Array, Function, Object],
            default: () => null
        },
        eventColor: {
            type: [Array, Function, Object, String],
            default: () => 'warning'
        },
        hoverLink: {
            type: String,
            default: ''
        },
        locale: {
            type: String,
            default: 'en-us'
        },
        min: String,
        max: String,
        range: Boolean,
        readonly: Boolean,
        scrollable: Boolean,
        tableDate: {
            type: String,
            required: true
        },
        value: [String, Array],
        viewing: String
    },
    data: () => ({
        isReversing: false,
        hovering: ''
    }),
    computed: {
        computedTransition() {
            return (this.isReversing === !this.$vuetify.rtl) ? 'tab-reverse-transition' : 'tab-transition';
        },
        displayedMonth() {
            return Number(this.tableDate.split('-')[1]) - 1;
        },
        displayedYear() {
            return Number(this.tableDate.split('-')[0]);
        }
    },
    watch: {
        tableDate(newVal, oldVal) {
            this.isReversing = newVal < oldVal;
        },
        hovering(value) {
            this.$emit('hover', value);
        }
    },
    methods: {
        genButtonClasses(isAllowed, isFloating, isSelected, isCurrent, isRange, isHover, isRangeStart, isRangeEnd) {
            return {
                'v-btn--range': isRange,
                'v-btn--range-hover': isRange && isHover,
                'v-btn--range-start': isRange && isRangeStart,
                'v-btn--range-end': isRange && isRangeEnd,
                'v-btn--active': isSelected,
                'v-btn--flat': !isSelected,
                'v-btn--icon': isSelected && isAllowed && isFloating,
                'v-btn--floating': isFloating,
                'v-btn--depressed': !isFloating && isSelected,
                'v-btn--disabled': !isAllowed || (this.disabled && isSelected),
                'v-btn--outline': isCurrent && !isSelected,
                ...this.themeClasses
            };
        },
        genButtonEvents(value, isAllowed, mouseEventType) {
            if (this.disabled)
                return undefined;
            return {
                click: () => {
                    isAllowed && !this.readonly && this.$emit('input', value);
                    this.$emit(`click:${mouseEventType}`, value);
                },
                dblclick: () => this.$emit(`dblclick:${mouseEventType}`, value),
                mouseover: () => {
                    this.hovering = value;
                },
                mouseleave: () => {
                    this.hovering = '';
                }
            };
        },
        genButton(value, isFloating, mouseEventType, formatter) {
            const isAllowed = isDateAllowed(value, this.min, this.max, this.allowedDates);
            const isSelected = value === this.value || (Array.isArray(this.value) && this.value.indexOf(value) !== -1);
            const isCurrent = value === this.current;
            const isHover = value === this.hovering;
            const isRange = this.range && this.value.length > 0;
            const inView = isRange ? mouseEventType === 'month' && formatter(this.viewing) === formatter(value) : false;
            const isInRange = isDateInRange(value, this.value);
            const isRangeEnd = (isRange && (value === this.value[1] ||
                (!isInRange && ((value === this.value[0] && isHoverBeforeStartDate(this.value[0], this.hoverLink)) ||
                    (value === this.hovering && isHoverAfterStartDate(this.value[0], this.hoverLink))))));
            const isRangeStart = isRange && !isRangeEnd && (value === this.value[0] ||
                (value === this.hovering && isHoverBeforeStartDate(this.value[0], this.hoverLink)));
            const setColor = isSelected || isRange || inView ? this.setBackgroundColor : this.setTextColor;
            const color = this.getFinalColor(value, (isSelected || isCurrent || inView) && (this.color || 'accent'));
            return this.$createElement('button', setColor(color, {
                staticClass: 'v-btn',
                'class': this.genButtonClasses(isAllowed, isFloating, isSelected || inView, isCurrent, isRange, isHover, isRangeStart, isRangeEnd),
                attrs: {
                    type: 'button'
                },
                props: {
                    isHovering: false
                },
                domProps: {
                    disabled: this.disabled || !isAllowed
                },
                on: this.genButtonEvents(value, isAllowed, mouseEventType)
            }), [
                this.$createElement('div', {
                    staticClass: 'v-btn__content'
                }, [formatter(value)]),
                this.genEvents(value)
            ]);
        },
        getFinalColor(date, color) {
            const colorInRange = Array.isArray(this.value) && isDateInRange(date, this.value);
            const colorInRangeHover = Array.isArray(this.value) && (this.value.length === 1) && (typeof this.value[0] === 'string') && isDateInHoverRange(date, this.value[0], this.hoverLink);
            const colorRangeNode = Array.isArray(this.value) && (this.value.indexOf(date) === 0 || date === this.value[this.value.length - 1]);
            return colorRangeNode ? `${this.color} accent darken-4` : colorInRange ? `${this.color} accent darken-2` : colorInRangeHover ? `${this.color} accent darken-3` : color;
        },
        getEventColors(date) {
            const arrayize = (v) => Array.isArray(v) ? v : [v];
            let eventData;
            let eventColors = [];
            if (Array.isArray(this.events)) {
                eventData = this.events.includes(date);
            }
            else if (this.events instanceof Function) {
                eventData = this.events(date) || false;
            }
            else if (this.events) {
                eventData = this.events[date] || false;
            }
            else {
                eventData = false;
            }
            if (!eventData) {
                return [];
            }
            else if (eventData !== true) {
                eventColors = arrayize(eventData);
            }
            else if (typeof this.eventColor === 'string') {
                eventColors = [this.eventColor];
            }
            else if (typeof this.eventColor === 'function') {
                eventColors = arrayize(this.eventColor(date));
            }
            else if (Array.isArray(this.eventColor)) {
                eventColors = this.eventColor;
            }
            else {
                eventColors = arrayize(this.eventColor[date]);
            }
            return eventColors.filter(v => v);
        },
        genEvents(date) {
            const eventColors = this.getEventColors(date);
            return eventColors.length ? this.$createElement('div', {
                staticClass: 'v-date-picker-table__events'
            }, eventColors.map(color => this.$createElement('div', this.setBackgroundColor(color)))) : null;
        },
        wheel(e, calculateTableDate) {
            e.preventDefault();
            this.$emit('tableDate', calculateTableDate(e.deltaY));
        },
        touch(value, calculateTableDate) {
            this.$emit('tableDate', calculateTableDate(value));
        },
        genTable(staticClass, children, calculateTableDate) {
            const transition = this.$createElement('transition', {
                props: { name: this.computedTransition }
            }, [this.$createElement('table', { key: this.tableDate }, children)]);
            const touchDirective = {
                name: 'touch',
                value: {
                    left: (e) => (e.offsetX < -15) && this.touch(1, calculateTableDate),
                    right: (e) => (e.offsetX > 15) && this.touch(-1, calculateTableDate)
                }
            };
            return this.$createElement('div', {
                staticClass,
                class: {
                    'v-date-picker-table--disabled': this.disabled,
                    ...this.themeClasses
                },
                on: (!this.disabled && this.scrollable) ? {
                    wheel: (e) => this.wheel(e, calculateTableDate)
                } : undefined,
                directives: [touchDirective]
            }, [transition]);
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1waWNrZXItdGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WRGF0ZVBpY2tlci9taXhpbnMvZGF0ZS1waWNrZXItdGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxvREFBb0QsQ0FBQTtBQUUzRCxhQUFhO0FBQ2IsT0FBTyxLQUF1QixNQUFNLDJCQUEyQixDQUFBO0FBRS9ELFNBQVM7QUFDVCxPQUFPLFNBQVMsTUFBTSwyQkFBMkIsQ0FBQTtBQUNqRCxPQUFPLFNBQVMsTUFBTSwyQkFBMkIsQ0FBQTtBQUVqRCxRQUFRO0FBQ1IsT0FBTyxhQUFzQyxNQUFNLHVCQUF1QixDQUFBO0FBQzFFLE9BQU8sYUFBYSxFQUFFLEVBQUUsa0JBQWtCLEVBQUUscUJBQXFCLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQTtBQUN4SCxPQUFPLE1BQU0sTUFBTSxzQkFBc0IsQ0FBQTtBQVd6QyxlQUFlLE1BQU0sQ0FDbkIsU0FBUyxFQUNULFNBQVM7QUFDWCxvQkFBb0I7Q0FDbkIsQ0FBQyxNQUFNLENBQUM7SUFDUCxVQUFVLEVBQUUsRUFBRSxLQUFLLEVBQUU7SUFFckIsS0FBSyxFQUFFO1FBQ0wsWUFBWSxFQUFFLFFBQTBEO1FBQ3hFLE9BQU8sRUFBRSxNQUFNO1FBQ2YsUUFBUSxFQUFFLE9BQU87UUFDakIsTUFBTSxFQUFFLFFBQTBEO1FBQ2xFLE1BQU0sRUFBRTtZQUNOLElBQUksRUFBRSxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDO1lBQy9CLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJO1NBQ2dCO1FBQ3JDLFVBQVUsRUFBRTtZQUNWLElBQUksRUFBRSxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQztZQUN2QyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsU0FBUztTQUNnQjtRQUMxQyxTQUFTLEVB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TCxJQUFJLEVBQUUsQ0FBQyxDQUFlLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLGtCQUFrQixDQUFDO29CQUNqRixLQUFLLEVBQUUsQ0FBQyxDQUFlLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLGtCQUFrQixDQUFDO2lCQUNuRjthQUNGLENBQUE7WUFFRCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFO2dCQUNoQyxXQUFXO2dCQUNYLEtBQUssRUFBRTtvQkFDTCwrQkFBK0IsRUFBRSxJQUFJLENBQUMsUUFBUTtvQkFDOUMsR0FBRyxJQUFJLENBQUMsWUFBWTtpQkFDckI7Z0JBQ0QsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3hDLEtBQUssRUFBRSxDQUFDLENBQWEsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsa0JBQWtCLENBQUM7aUJBQzVELENBQUMsQ0FBQyxDQUFDLFNBQVM7Z0JBQ2IsVUFBVSxFQUFFLENBQUMsY0FBYyxDQUFDO2FBQzdCLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFBO1FBQ2xCLENBQUM7S0FDRjtDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnLi4vLi4vLi4vc3R5bHVzL2NvbXBvbmVudHMvX2RhdGUtcGlja2VyLXRhYmxlLnN0eWwnXHJcblxyXG4vLyBEaXJlY3RpdmVzXHJcbmltcG9ydCBUb3VjaCwgeyBUb3VjaFdyYXBwZXIgfSBmcm9tICcuLi8uLi8uLi9kaXJlY3RpdmVzL3RvdWNoJ1xyXG5cclxuLy8gTWl4aW5zXHJcbmltcG9ydCBDb2xvcmFibGUgZnJvbSAnLi4vLi4vLi4vbWl4aW5zL2NvbG9yYWJsZSdcclxuaW1wb3J0IFRoZW1lYWJsZSBmcm9tICcuLi8uLi8uLi9taXhpbnMvdGhlbWVhYmxlJ1xyXG5cclxuLy8gVXRpbHNcclxuaW1wb3J0IGlzRGF0ZUFsbG93ZWQsIHsgQWxsb3dlZERhdGVGdW5jdGlvbiB9IGZyb20gJy4uL3V0aWwvaXNEYXRlQWxsb3dlZCdcclxuaW1wb3J0IGlzRGF0ZUluUmFuZ2UsIHsgaXNEYXRlSW5Ib3ZlclJhbmdlLCBpc0hvdmVyQWZ0ZXJTdGFydERhdGUsIGlzSG92ZXJCZWZvcmVTdGFydERhdGUgfSBmcm9tICcuLi91dGlsL2lzRGF0ZUluUmFuZ2UnXHJcbmltcG9ydCBtaXhpbnMgZnJvbSAnLi4vLi4vLi4vdXRpbC9taXhpbnMnXHJcblxyXG4vLyBUeXBlc1xyXG5pbXBvcnQgeyBWTm9kZUNoaWxkcmVuIH0gZnJvbSAndnVlJ1xyXG5pbXBvcnQgeyBQcm9wVmFsaWRhdG9yIH0gZnJvbSAndnVlL3R5cGVzL29wdGlvbnMnXHJcbmltcG9ydCB7IERhdGVQaWNrZXJGb3JtYXR0ZXIgfSBmcm9tICcuLi91dGlsL2NyZWF0ZU5hdGl2ZUxvY2FsZUZvcm1hdHRlcidcclxuaW1wb3J0IHsgRGF0ZUV2ZW50cywgRGF0ZUV2ZW50Q29sb3JzLCBEYXRlRXZlbnRDb2xvclZhbHVlIH0gZnJvbSAnLi4vVkRhdGVQaWNrZXInXHJcbi8vIGltcG9ydCB7IGVtaXQgfSBmcm9tICdjbHVzdGVyJztcclxuXHJcbnR5cGUgQ2FsY3VsYXRlVGFibGVEYXRlRnVuY3Rpb24gPSAodjogbnVtYmVyKSA9PiBzdHJpbmdcclxuXHJcbmV4cG9ydCBkZWZhdWx0IG1peGlucyhcclxuICBDb2xvcmFibGUsXHJcbiAgVGhlbWVhYmxlXHJcbi8qIEB2dWUvY29tcG9uZW50ICovXHJcbikuZXh0ZW5kKHtcclxuICBkaXJlY3RpdmVzOiB7IFRvdWNoIH0sXHJcblxyXG4gIHByb3BzOiB7XHJcbiAgICBhbGxvd2VkRGF0ZXM6IEZ1bmN0aW9uIGFzIFByb3BWYWxpZGF0b3I8QWxsb3dlZERhdGVGdW5jdGlvbiB8IHVuZGVmaW5lZD4sXHJcbiAgICBjdXJyZW50OiBTdHJpbmcsXHJcbiAgICBkaXNhYmxlZDogQm9vbGVhbixcclxuICAgIGZvcm1hdDogRnVuY3Rpb24gYXMgUHJvcFZhbGlkYXRvcjxEYXRlUGlja2VyRm9ybWF0dGVyIHwgdW5kZWZpbmVkPixcclxuICAgIGV2ZW50czoge1xyXG4gICAgICB0eXBlOiBbQXJyYXksIEZ1bmN0aW9uLCBPYmplY3RdLFxyXG4gICAgICBkZWZhdWx0OiAoKSA9PiBudWxsXHJcbiAgICB9IGFzIGFueSBhcyBQcm9wVmFsaWRhdG9yPERhdGVFdmVudHM+LFxyXG4gICAgZXZlbnRDb2xvcjoge1xyXG4gICAgICB0eXBlOiBbQXJyYXksIEZ1bmN0aW9uLCBPYmplY3QsIFN0cmluZ10sXHJcbiAgICAgIGRlZmF1bHQ6ICgpID0+ICd3YXJuaW5nJ1xyXG4gICAgfSBhcyBhbnkgYXMgUHJvcFZhbGlkYXRvcjxEYXRlRXZlbnRDb2xvcnM+LFxyXG4gICAgaG92ZXJMaW5rOiB7XHJcbiAgICAgIHR5cGU6IFN0cmluZyxcclxuICAgICAgZGVmYXVsdDogJydcclxuICAgIH0sXHJcbiAgICBsb2NhbGU6IHtcclxuICAgICAgdHlwZTogU3RyaW5nLFxyXG4gICAgICBkZWZhdWx0OiAnZW4tdXMnXHJcbiAgICB9LFxyXG4gICAgbWluOiBTdHJpbmcsXHJcbiAgICBtYXg6IFN0cmluZyxcclxuICAgIHJhbmdlOiBCb29sZWFuLFxyXG4gICAgcmVhZG9ubHk6IEJvb2xlYW4sXHJcbiAgICBzY3JvbGxhYmxlOiBCb29sZWFuLFxyXG4gICAgdGFibGVEYXRlOiB7XHJcbiAgICAgIHR5cGU6IFN0cmluZyxcclxuICAgICAgcmVxdWlyZWQ6IHRydWVcclxuICAgIH0sXHJcbiAgICB2YWx1ZTogW1N0cmluZywgQXJyYXldLFxyXG4gICAgdmlld2luZzogU3RyaW5nXHJcbiAgfSxcclxuXHJcbiAgZGF0YTogKCkgPT4gKHtcclxuICAgIGlzUmV2ZXJzaW5nOiBmYWxzZSxcclxuICAgIGhvdmVyaW5nOiAnJ1xyXG4gIH0pLFxyXG5cclxuICBjb21wdXRlZDoge1xyXG4gICAgY29tcHV0ZWRUcmFuc2l0aW9uICgpOiBzdHJpbmcge1xyXG4gICAgICByZXR1cm4gKHRoaXMuaXNSZXZlcnNpbmcgPT09ICF0aGlzLiR2dWV0aWZ5LnJ0bCkgPyAndGFiLXJldmVyc2UtdHJhbnNpdGlvbicgOiAndGFiLXRyYW5zaXRpb24nXHJcbiAgICB9LFxyXG4gICAgZGlzcGxheWVkTW9udGggKCk6IG51bWJlciB7XHJcbiAgICAgIHJldHVybiBOdW1iZXIodGhpcy50YWJsZURhdGUuc3BsaXQoJy0nKVsxXSkgLSAxXHJcbiAgICB9LFxyXG4gICAgZGlzcGxheWVkWWVhciAoKTogbnVtYmVyIHtcclxuICAgICAgcmV0dXJuIE51bWJlcih0aGlzLnRhYmxlRGF0ZS5zcGxpdCgnLScpWzBdKVxyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIHdhdGNoOiB7XHJcbiAgICB0YWJsZURhdGUgKG5ld1ZhbDogc3RyaW5nLCBvbGRWYWw6IHN0cmluZykge1xyXG4gICAgICB0aGlzLmlzUmV2ZXJzaW5nID0gbmV3VmFsIDwgb2xkVmFsXHJcbiAgICB9LFxyXG4gICAgaG92ZXJpbmcgKHZhbHVlKSB7XHJcbiAgICAgIHRoaXMuJGVtaXQoJ2hvdmVyJywgdmFsdWUpXHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgbWV0aG9kczoge1xyXG4gICAgZ2VuQnV0dG9uQ2xhc3NlcyAoXHJcbiAgICAgIGlzQWxsb3dlZDogYm9vbGVhbixcclxuICAgICAgaXNGbG9hdGluZzogYm9vbGVhbixcclxuICAgICAgaXNTZWxlY3RlZDogYm9vbGVhbixcclxuICAgICAgaXNDdXJyZW50OiBib29sZWFuLFxyXG4gICAgICBpc1JhbmdlOiBib29sZWFuLFxyXG4gICAgICBpc0hvdmVyOiBib29sZWFuLFxyXG4gICAgICBpc1JhbmdlU3RhcnQ6IGJvb2xlYW4sXHJcbiAgICAgIGlzUmFuZ2VFbmQ6IGJvb2xlYW5cclxuICAgICkge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgICd2LWJ0bi0tcmFuZ2UnOiBpc1JhbmdlLFxyXG4gICAgICAgICd2LWJ0bi0tcmFuZ2UtaG92ZXInOiBpc1JhbmdlICYmIGlzSG92ZXIsXHJcbiAgICAgICAgJ3YtYnRuLS1yYW5nZS1zdGFydCc6IGlzUmFuZ2UgJiYgaXNSYW5nZVN0YXJ0LFxyXG4gICAgICAgICd2LWJ0bi0tcmFuZ2UtZW5kJzogaXNSYW5nZSAmJiBpc1JhbmdlRW5kLFxyXG4gICAgICAgICd2LWJ0bi0tYWN0aXZlJzogaXNTZWxlY3RlZCxcclxuICAgICAgICAndi1idG4tLWZsYXQnOiAhaXNTZWxlY3RlZCxcclxuICAgICAgICAndi1idG4tLWljb24nOiBpc1NlbGVjdGVkICYmIGlzQWxsb3dlZCAmJiBpc0Zsb2F0aW5nLFxyXG4gICAgICAgICd2LWJ0bi0tZmxvYXRpbmcnOiBpc0Zsb2F0aW5nLFxyXG4gICAgICAgICd2LWJ0bi0tZGVwcmVzc2VkJzogIWlzRmxvYXRpbmcgJiYgaXNTZWxlY3RlZCxcclxuICAgICAgICAndi1idG4tLWRpc2FibGVkJzogIWlzQWxsb3dlZCB8fCAodGhpcy5kaXNhYmxlZCAmJiBpc1NlbGVjdGVkKSxcclxuICAgICAgICAndi1idG4tLW91dGxpbmUnOiBpc0N1cnJlbnQgJiYgIWlzU2VsZWN0ZWQsXHJcbiAgICAgICAgLi4udGhpcy50aGVtZUNsYXNzZXNcclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIGdlbkJ1dHRvbkV2ZW50cyAodmFsdWU6IHN0cmluZywgaXNBbGxvd2VkOiBib29sZWFuLCBtb3VzZUV2ZW50VHlwZTogc3RyaW5nKSB7XHJcbiAgICAgIGlmICh0aGlzLmRpc2FibGVkKSByZXR1cm4gdW5kZWZpbmVkXHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGNsaWNrOiAoKSA9PiB7XHJcbiAgICAgICAgICBpc0FsbG93ZWQgJiYgIXRoaXMucmVhZG9ubHkgJiYgdGhpcy4kZW1pdCgnaW5wdXQnLCB2YWx1ZSlcclxuICAgICAgICAgIHRoaXMuJGVtaXQoYGNsaWNrOiR7bW91c2VFdmVudFR5cGV9YCwgdmFsdWUpXHJcbiAgICAgICAgfSxcclxuICAgICAgICBkYmxjbGljazogKCkgPT4gdGhpcy4kZW1pdChgZGJsY2xpY2s6JHttb3VzZUV2ZW50VHlwZX1gLCB2YWx1ZSksXHJcbiAgICAgICAgbW91c2VvdmVyOiAoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmhvdmVyaW5nID0gdmFsdWVcclxuICAgICAgICB9LFxyXG4gICAgICAgIG1vdXNlbGVhdmU6ICgpID0+IHtcclxuICAgICAgICAgIHRoaXMuaG92ZXJpbmcgPSAnJ1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIGdlbkJ1dHRvbiAodmFsdWU6IHN0cmluZywgaXNGbG9hdGluZzogYm9vbGVhbiwgbW91c2VFdmVudFR5cGU6IHN0cmluZywgZm9ybWF0dGVyOiBEYXRlUGlja2VyRm9ybWF0dGVyKSB7XHJcbiAgICAgIGNvbnN0IGlzQWxsb3dlZCA9IGlzRGF0ZUFsbG93ZWQodmFsdWUsIHRoaXMubWluLCB0aGlzLm1heCwgdGhpcy5hbGxvd2VkRGF0ZXMpXHJcbiAgICAgIGNvbnN0IGlzU2VsZWN0ZWQgPSB2YWx1ZSA9PT0gdGhpcy52YWx1ZSB8fCAoQXJyYXkuaXNBcnJheSh0aGlzLnZhbHVlKSAmJiB0aGlzLnZhbHVlLmluZGV4T2YodmFsdWUpICE9PSAtMSlcclxuICAgICAgY29uc3QgaXNDdXJyZW50ID0gdmFsdWUgPT09IHRoaXMuY3VycmVudFxyXG4gICAgICBjb25zdCBpc0hvdmVyID0gdmFsdWUgPT09IHRoaXMuaG92ZXJpbmdcclxuICAgICAgY29uc3QgaXNSYW5nZSA9IHRoaXMucmFuZ2UgJiYgdGhpcy52YWx1ZS5sZW5ndGggPiAwXHJcbiAgICAgIGNvbnN0IGluVmlldyA9IGlzUmFuZ2UgPyBtb3VzZUV2ZW50VHlwZSA9PT0gJ21vbnRoJyAmJiBmb3JtYXR0ZXIodGhpcy52aWV3aW5nKSA9PT0gZm9ybWF0dGVyKHZhbHVlKSA6IGZhbHNlXHJcbiAgICAgIGNvbnN0IGlzSW5SYW5nZSA9IGlzRGF0ZUluUmFuZ2UodmFsdWUsIHRoaXMudmFsdWUpXHJcbiAgICAgIGNvbnN0IGlzUmFuZ2VFbmQgPSAoaXNSYW5nZSAmJiAoXHJcbiAgICAgICAgdmFsdWUgPT09IHRoaXMudmFsdWVbMV0gfHxcclxuICAgICAgICAoIWlzSW5SYW5nZSAmJiAoXHJcbiAgICAgICAgICAodmFsdWUgPT09IHRoaXMudmFsdWVbMF0gJiYgaXNIb3ZlckJlZm9yZVN0YXJ0RGF0ZSh0aGlzLnZhbHVlWzBdLCB0aGlzLmhvdmVyTGluaykpIHx8XHJcbiAgICAgICAgICAodmFsdWUgPT09IHRoaXMuaG92ZXJpbmcgJiYgaXNIb3ZlckFmdGVyU3RhcnREYXRlKHRoaXMudmFsdWVbMF0sIHRoaXMuaG92ZXJMaW5rKSlcclxuICAgICAgICApKVxyXG4gICAgICApKVxyXG4gICAgICBjb25zdCBpc1JhbmdlU3RhcnQgPSBpc1JhbmdlICYmICFpc1JhbmdlRW5kICYmIChcclxuICAgICAgICB2YWx1ZSA9PT0gdGhpcy52YWx1ZVswXSB8fFxyXG4gICAgICAgICh2YWx1ZSA9PT0gdGhpcy5ob3ZlcmluZyAmJiBpc0hvdmVyQmVmb3JlU3RhcnREYXRlKHRoaXMudmFsdWVbMF0sIHRoaXMuaG92ZXJMaW5rKSlcclxuICAgICAgKVxyXG4gICAgICBjb25zdCBzZXRDb2xvciA9IGlzU2VsZWN0ZWQgfHwgaXNSYW5nZSB8fCBpblZpZXcgPyB0aGlzLnNldEJhY2tncm91bmRDb2xvciA6IHRoaXMuc2V0VGV4dENvbG9yXHJcblxyXG4gICAgICBjb25zdCBjb2xvciA9IHRoaXMuZ2V0RmluYWxDb2xvcih2YWx1ZSwgKGlzU2VsZWN0ZWQgfHwgaXNDdXJyZW50IHx8IGluVmlldykgJiYgKHRoaXMuY29sb3IgfHwgJ2FjY2VudCcpKVxyXG5cclxuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicsIHNldENvbG9yKGNvbG9yLCB7XHJcbiAgICAgICAgc3RhdGljQ2xhc3M6ICd2LWJ0bicsXHJcbiAgICAgICAgJ2NsYXNzJzogdGhpcy5nZW5CdXR0b25DbGFzc2VzKGlzQWxsb3dlZCwgaXNGbG9hdGluZywgaXNTZWxlY3RlZCB8fCBpblZpZXcsIGlzQ3VycmVudCwgaXNSYW5nZSwgaXNIb3ZlciwgaXNSYW5nZVN0YXJ0LCBpc1JhbmdlRW5kKSxcclxuICAgICAgICBhdHRyczoge1xyXG4gICAgICAgICAgdHlwZTogJ2J1dHRvbidcclxuICAgICAgICB9LFxyXG4gICAgICAgIHByb3BzOiB7XHJcbiAgICAgICAgICBpc0hvdmVyaW5nOiBmYWxzZVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZG9tUHJvcHM6IHtcclxuICAgICAgICAgIGRpc2FibGVkOiB0aGlzLmRpc2FibGVkIHx8ICFpc0FsbG93ZWRcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uOiB0aGlzLmdlbkJ1dHRvbkV2ZW50cyh2YWx1ZSwgaXNBbGxvd2VkLCBtb3VzZUV2ZW50VHlwZSlcclxuICAgICAgfSksIFtcclxuICAgICAgICB0aGlzLiRjcmVhdGVFbGVtZW50KCdkaXYnLCB7XHJcbiAgICAgICAgICBzdGF0aWNDbGFzczogJ3YtYnRuX19jb250ZW50J1xyXG4gICAgICAgIH0sIFtmb3JtYXR0ZXIodmFsdWUpXSksXHJcbiAgICAgICAgdGhpcy5nZW5FdmVudHModmFsdWUpXHJcbiAgICAgIF0pXHJcbiAgICB9LFxyXG4gICAgZ2V0RmluYWxDb2xvciAoZGF0ZTogc3RyaW5nLCBjb2xvcjogc3RyaW5nIHwgZmFsc2UpIHtcclxuICAgICAgY29uc3QgY29sb3JJblJhbmdlID0gQXJyYXkuaXNBcnJheSh0aGlzLnZhbHVlKSAmJiBpc0RhdGVJblJhbmdlKGRhdGUsIHRoaXMudmFsdWUpXHJcbiAgICAgIGNvbnN0IGNvbG9ySW5SYW5nZUhvdmVyID0gQXJyYXkuaXNBcnJheSh0aGlzLnZhbHVlKSAmJiAodGhpcy52YWx1ZS5sZW5ndGggPT09IDEpICYmICh0eXBlb2YgdGhpcy52YWx1ZVswXSA9PT0gJ3N0cmluZycpICYmIGlzRGF0ZUluSG92ZXJSYW5nZShkYXRlLCB0aGlzLnZhbHVlWzBdLCB0aGlzLmhvdmVyTGluaylcclxuICAgICAgY29uc3QgY29sb3JSYW5nZU5vZGUgPSBBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpICYmICh0aGlzLnZhbHVlLmluZGV4T2YoZGF0ZSkgPT09IDAgfHwgZGF0ZSA9PT0gdGhpcy52YWx1ZVt0aGlzLnZhbHVlLmxlbmd0aCAtIDFdKVxyXG4gICAgICByZXR1cm4gY29sb3JSYW5nZU5vZGUgPyBgJHt0aGlzLmNvbG9yfSBhY2NlbnQgZGFya2VuLTRgIDogY29sb3JJblJhbmdlID8gYCR7dGhpcy5jb2xvcn0gYWNjZW50IGRhcmtlbi0yYCA6IGNvbG9ySW5SYW5nZUhvdmVyID8gYCR7dGhpcy5jb2xvcn0gYWNjZW50IGRhcmtlbi0zYCA6IGNvbG9yXHJcbiAgICB9LFxyXG4gICAgZ2V0RXZlbnRDb2xvcnMgKGRhdGU6IHN0cmluZykge1xyXG4gICAgICBjb25zdCBhcnJheWl6ZSA9ICh2OiBzdHJpbmcgfCBzdHJpbmdbXSkgPT4gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl1cclxuICAgICAgbGV0IGV2ZW50RGF0YTogYm9vbGVhbiB8IERhdGVFdmVudENvbG9yVmFsdWVcclxuICAgICAgbGV0IGV2ZW50Q29sb3JzOiBzdHJpbmdbXSA9IFtdXHJcblxyXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmV2ZW50cykpIHtcclxuICAgICAgICBldmVudERhdGEgPSB0aGlzLmV2ZW50cy5pbmNsdWRlcyhkYXRlKVxyXG4gICAgICB9IGVsc2UgaWYgKHRoaXMuZXZlbnRzIGluc3RhbmNlb2YgRnVuY3Rpb24pIHtcclxuICAgICAgICBldmVudERhdGEgPSB0aGlzLmV2ZW50cyhkYXRlKSB8fCBmYWxzZVxyXG4gICAgICB9IGVsc2UgaWYgKHRoaXMuZXZlbnRzKSB7XHJcbiAgICAgICAgZXZlbnREYXRhID0gdGhpcy5ldmVudHNbZGF0ZV0gfHwgZmFsc2VcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBldmVudERhdGEgPSBmYWxzZVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIWV2ZW50RGF0YSkge1xyXG4gICAgICAgIHJldHVybiBbXVxyXG4gICAgICB9IGVsc2UgaWYgKGV2ZW50RGF0YSAhPT0gdHJ1ZSkge1xyXG4gICAgICAgIGV2ZW50Q29sb3JzID0gYXJyYXlpemUoZXZlbnREYXRhKVxyXG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0aGlzLmV2ZW50Q29sb3IgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgZXZlbnRDb2xvcnMgPSBbdGhpcy5ldmVudENvbG9yXVxyXG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0aGlzLmV2ZW50Q29sb3IgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICBldmVudENvbG9ycyA9IGFycmF5aXplKHRoaXMuZXZlbnRDb2xvcihkYXRlKSlcclxuICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHRoaXMuZXZlbnRDb2xvcikpIHtcclxuICAgICAgICBldmVudENvbG9ycyA9IHRoaXMuZXZlbnRDb2xvclxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGV2ZW50Q29sb3JzID0gYXJyYXlpemUodGhpcy5ldmVudENvbG9yW2RhdGVdKVxyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gZXZlbnRDb2xvcnMuZmlsdGVyKHYgPT4gdilcclxuICAgIH0sXHJcbiAgICBnZW5FdmVudHMgKGRhdGU6IHN0cmluZykge1xyXG4gICAgICBjb25zdCBldmVudENvbG9ycyA9IHRoaXMuZ2V0RXZlbnRDb2xvcnMoZGF0ZSlcclxuXHJcbiAgICAgIHJldHVybiBldmVudENvbG9ycy5sZW5ndGggPyB0aGlzLiRjcmVhdGVFbGVtZW50KCdkaXYnLCB7XHJcbiAgICAgICAgc3RhdGljQ2xhc3M6ICd2LWRhdGUtcGlja2VyLXRhYmxlX19ldmVudHMnXHJcbiAgICAgIH0sIGV2ZW50Q29sb3JzLm1hcChjb2xvciA9PiB0aGlzLiRjcmVhdGVFbGVtZW50KCdkaXYnLCB0aGlzLnNldEJhY2tncm91bmRDb2xvcihjb2xvcikpKSkgOiBudWxsXHJcbiAgICB9LFxyXG4gICAgd2hlZWwgKGU6IFdoZWVsRXZlbnQsIGNhbGN1bGF0ZVRhYmxlRGF0ZTogQ2FsY3VsYXRlVGFibGVEYXRlRnVuY3Rpb24pIHtcclxuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpXHJcbiAgICAgIHRoaXMuJGVtaXQoJ3RhYmxlRGF0ZScsIGNhbGN1bGF0ZVRhYmxlRGF0ZShlLmRlbHRhWSkpXHJcbiAgICB9LFxyXG4gICAgdG91Y2ggKHZhbHVlOiBudW1iZXIsIGNhbGN1bGF0ZVRhYmxlRGF0ZTogQ2FsY3VsYXRlVGFibGVEYXRlRnVuY3Rpb24pIHtcclxuICAgICAgdGhpcy4kZW1pdCgndGFibGVEYXRlJywgY2FsY3VsYXRlVGFibGVEYXRlKHZhbHVlKSlcclxuICAgIH0sXHJcbiAgICBnZW5UYWJsZSAoc3RhdGljQ2xhc3M6IHN0cmluZywgY2hpbGRyZW46IFZOb2RlQ2hpbGRyZW4sIGNhbGN1bGF0ZVRhYmxlRGF0ZTogQ2FsY3VsYXRlVGFibGVEYXRlRnVuY3Rpb24pIHtcclxuICAgICAgY29uc3QgdHJhbnNpdGlvbiA9IHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RyYW5zaXRpb24nLCB7XHJcbiAgICAgICAgcHJvcHM6IHsgbmFtZTogdGhpcy5jb21wdXRlZFRyYW5zaXRpb24gfVxyXG4gICAgICB9LCBbdGhpcy4kY3JlYXRlRWxlbWVudCgndGFibGUnLCB7IGtleTogdGhpcy50YWJsZURhdGUgfSwgY2hpbGRyZW4pXSlcclxuXHJcbiAgICAgIGNvbnN0IHRvdWNoRGlyZWN0aXZlID0ge1xyXG4gICAgICAgIG5hbWU6ICd0b3VjaCcsXHJcbiAgICAgICAgdmFsdWU6IHtcclxuICAgICAgICAgIGxlZnQ6IChlOiBUb3VjaFdyYXBwZXIpID0+IChlLm9mZnNldFggPCAtMTUpICYmIHRoaXMudG91Y2goMSwgY2FsY3VsYXRlVGFibGVEYXRlKSxcclxuICAgICAgICAgIHJpZ2h0OiAoZTogVG91Y2hXcmFwcGVyKSA9PiAoZS5vZmZzZXRYID4gMTUpICYmIHRoaXMudG91Y2goLTEsIGNhbGN1bGF0ZVRhYmxlRGF0ZSlcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCdkaXYnLCB7XHJcbiAgICAgICAgc3RhdGljQ2xhc3MsXHJcbiAgICAgICAgY2xhc3M6IHtcclxuICAgICAgICAgICd2LWRhdGUtcGlja2VyLXRhYmxlLS1kaXNhYmxlZCc6IHRoaXMuZGlzYWJsZWQsXHJcbiAgICAgICAgICAuLi50aGlzLnRoZW1lQ2xhc3Nlc1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb246ICghdGhpcy5kaXNhYmxlZCAmJiB0aGlzLnNjcm9sbGFibGUpID8ge1xyXG4gICAgICAgICAgd2hlZWw6IChlOiBXaGVlbEV2ZW50KSA9PiB0aGlzLndoZWVsKGUsIGNhbGN1bGF0ZVRhYmxlRGF0ZSlcclxuICAgICAgICB9IDogdW5kZWZpbmVkLFxyXG4gICAgICAgIGRpcmVjdGl2ZXM6IFt0b3VjaERpcmVjdGl2ZV1cclxuICAgICAgfSwgW3RyYW5zaXRpb25dKVxyXG4gICAgfVxyXG4gIH1cclxufSlcclxuIl19