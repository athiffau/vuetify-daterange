// Mixins
import DatePickerTable from './mixins/date-picker-table';
// Utils
import { pad, createNativeLocaleFormatter, monthChange } from './util';
import { createRange } from '../../util/helpers';
import mixins from '../../util/mixins';
export default mixins(DatePickerTable
/* @vue/component */
).extend({
    name: 'v-date-picker-date-table',
    props: {
        firstDayOfWeek: {
            type: [String, Number],
            default: 0
        },
        showWeek: Boolean,
        weekdayFormat: Function
    },
    computed: {
        formatter() {
            return this.format || createNativeLocaleFormatter(this.locale, { day: 'numeric', timeZone: 'UTC' }, { start: 8, length: 2 });
        },
        weekdayFormatter() {
            return this.weekdayFormat || createNativeLocaleFormatter(this.locale, { weekday: 'narrow', timeZone: 'UTC' });
        },
        weekDays() {
            const first = parseInt(this.firstDayOfWeek, 10);
            return this.weekdayFormatter
                ? createRange(7).map(i => this.weekdayFormatter(`2017-01-${first + i + 15}`)) // 2017-01-15 is Sunday
                : createRange(7).map(i => ['S', 'M', 'T', 'W', 'T', 'F', 'S'][(i + first) % 7]);
        }
    },
    methods: {
        calculateTableDate(delta) {
            return monthChange(this.tableDate, Math.sign(delta || 1));
        },
        genTHead() {
            const days = this.weekDays.map(day => this.$createElement('th', day));
            this.showWeek && days.unshift(this.$createElement('th'));
            return this.$createElement('thead', this.genTR(days));
        },
        // Returns number of the days from the firstDayOfWeek to the first day of the current month
        weekDaysBeforeFirstDayOfTheMonth() {
            const firstDayOfTheMonth = new Date(`${this.displayedYear}-${pad(this.displayedMonth + 1)}-01T00:00:00+00:00`);
            const weekDay = firstDayOfTheMonth.getUTCDay();
            return (weekDay - parseInt(this.firstDayOfWeek) + 7) % 7;
        },
        getWeekNumber() {
            let dayOfYear = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334][this.displayedMonth];
            if (this.displayedMonth > 1 &&
                (((this.displayedYear % 4 === 0) && (this.displayedYear % 100 !== 0)) || (this.displayedYear % 400 === 0))) {
                dayOfYear++;
            }
            const offset = (this.displayedYear +
                ((this.displayedYear - 1) >> 2) -
                Math.floor((this.displayedYear - 1) / 100) +
                Math.floor((this.displayedYear - 1) / 400) -
                Number(this.firstDayOfWeek)) % 7; // https://en.wikipedia.org/wiki/Zeller%27s_congruence
            return Math.floor((dayOfYear + offset) / 7) + 1;
        },
        genWeekNumber(weekNumber) {
            return this.$createElement('td', [
                this.$createElement('small', {
                    staticClass: 'v-date-picker-table--date__week'
                }, String(weekNumber).padStart(2, '0'))
            ]);
        },
        genTBody() {
            const children = [];
            const daysInMonth = new Date(this.displayedYear, this.displayedMonth + 1, 0).getDate();
            let rows = [];
            let day = this.weekDaysBeforeFirstDayOfTheMonth();
            let weekNumber = this.getWeekNumber();
            this.showWeek && rows.push(this.genWeekNumber(weekNumber++));
            while (day--)
                rows.push(this.$createElement('td'));
            for (day = 1; day <= daysInMonth; day++) {
                const date = `${this.displayedYear}-${pad(this.displayedMonth + 1)}-${pad(day)}`;
                rows.push(this.$createElement('td', [
                    this.genButton(date, true, 'date', this.formatter)
                ]));
                if (rows.length % (this.showWeek ? 8 : 7) === 0) {
                    children.push(this.genTR(rows));
                    rows = [];
                    day < daysInMonth && this.showWeek && rows.push(this.genWeekNumber(weekNumber++));
                }
            }
            if (rows.length) {
                children.push(this.genTR(rows));
            }
            return this.$createElement('tbody', children);
        },
        genTR(children) {
            return [this.$createElement('tr', children)];
        }
    },
    render() {
        return this.genTable('v-date-picker-table v-date-picker-table--date', [
            this.genTHead(),
            this.genTBody()
        ], this.calculateTableDate);
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkRhdGVQaWNrZXJEYXRlVGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WRGF0ZVBpY2tlci9WRGF0ZVBpY2tlckRhdGVUYWJsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTyxlQUFlLE1BQU0sNEJBQTRCLENBQUE7QUFFeEQsUUFBUTtBQUNSLE9BQU8sRUFBRSxHQUFHLEVBQUUsMkJBQTJCLEVBQUUsV0FBVyxFQUFFLE1BQU0sUUFBUSxDQUFBO0FBQ3RFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUNoRCxPQUFPLE1BQU0sTUFBTSxtQkFBbUIsQ0FBQTtBQU90QyxlQUFlLE1BQU0sQ0FDbkIsZUFBZTtBQUNqQixvQkFBb0I7Q0FDbkIsQ0FBQyxNQUFNLENBQUM7SUFDUCxJQUFJLEVBQUUsMEJBQTBCO0lBRWhDLEtBQUssRUFBRTtRQUNMLGNBQWMsRUFBRTtZQUNkLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7WUFDdEIsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUNELFFBQVEsRUFBRSxPQUFPO1FBQ2pCLGFBQWEsRUFBRSxRQUEwRDtLQUMxRTtJQUVELFFBQVEsRUFBRTtRQUNSLFNBQVM7WUFDUCxPQUFPLElBQUksQ0FBQyxNQUFNLElBQUksMkJBQTJCLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUM5SCxDQUFDO1FBQ0QsZ0JBQWdCO1lBQ2QsT0FBTyxJQUFJLENBQUMsYUFBYSxJQUFJLDJCQUEyQixDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUs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RCxLQUFLLENBQUUsUUFBdUI7WUFDNUIsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUE7UUFDOUMsQ0FBQztLQUNGO0lBRUQsTUFBTTtRQUNKLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQywrQ0FBK0MsRUFBRTtZQUNwRSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2YsSUFBSSxDQUFDLFFBQVEsRUFBRTtTQUNoQixFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO0lBQzdCLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBNaXhpbnNcclxuaW1wb3J0IERhdGVQaWNrZXJUYWJsZSBmcm9tICcuL21peGlucy9kYXRlLXBpY2tlci10YWJsZSdcclxuXHJcbi8vIFV0aWxzXHJcbmltcG9ydCB7IHBhZCwgY3JlYXRlTmF0aXZlTG9jYWxlRm9ybWF0dGVyLCBtb250aENoYW5nZSB9IGZyb20gJy4vdXRpbCdcclxuaW1wb3J0IHsgY3JlYXRlUmFuZ2UgfSBmcm9tICcuLi8uLi91dGlsL2hlbHBlcnMnXHJcbmltcG9ydCBtaXhpbnMgZnJvbSAnLi4vLi4vdXRpbC9taXhpbnMnXHJcblxyXG4vLyBUeXBlc1xyXG5pbXBvcnQgeyBEYXRlUGlja2VyRm9ybWF0dGVyIH0gZnJvbSAnLi91dGlsL2NyZWF0ZU5hdGl2ZUxvY2FsZUZvcm1hdHRlcidcclxuaW1wb3J0IHsgUHJvcFZhbGlkYXRvciB9IGZyb20gJ3Z1ZS90eXBlcy9vcHRpb25zJ1xyXG5pbXBvcnQgeyBWTm9kZSwgVk5vZGVDaGlsZHJlbiB9IGZyb20gJ3Z1ZSdcclxuXHJcbmV4cG9ydCBkZWZhdWx0IG1peGlucyhcclxuICBEYXRlUGlja2VyVGFibGVcclxuLyogQHZ1ZS9jb21wb25lbnQgKi9cclxuKS5leHRlbmQoe1xyXG4gIG5hbWU6ICd2LWRhdGUtcGlja2VyLWRhdGUtdGFibGUnLFxyXG5cclxuICBwcm9wczoge1xyXG4gICAgZmlyc3REYXlPZldlZWs6IHtcclxuICAgICAgdHlwZTogW1N0cmluZywgTnVtYmVyXSxcclxuICAgICAgZGVmYXVsdDogMFxyXG4gICAgfSxcclxuICAgIHNob3dXZWVrOiBCb29sZWFuLFxyXG4gICAgd2Vla2RheUZvcm1hdDogRnVuY3Rpb24gYXMgUHJvcFZhbGlkYXRvcjxEYXRlUGlja2VyRm9ybWF0dGVyIHwgdW5kZWZpbmVkPlxyXG4gIH0sXHJcblxyXG4gIGNvbXB1dGVkOiB7XHJcbiAgICBmb3JtYXR0ZXIgKCk6IERhdGVQaWNrZXJGb3JtYXR0ZXIge1xyXG4gICAgICByZXR1cm4gdGhpcy5mb3JtYXQgfHwgY3JlYXRlTmF0aXZlTG9jYWxlRm9ybWF0dGVyKHRoaXMubG9jYWxlLCB7IGRheTogJ251bWVyaWMnLCB0aW1lWm9uZTogJ1VUQycgfSwgeyBzdGFydDogOCwgbGVuZ3RoOiAyIH0pXHJcbiAgICB9LFxyXG4gICAgd2Vla2RheUZvcm1hdHRlciAoKTogRGF0ZVBpY2tlckZvcm1hdHRlciB8IHVuZGVmaW5lZCB7XHJcbiAgICAgIHJldHVybiB0aGlzLndlZWtkYXlGb3JtYXQgfHwgY3JlYXRlTmF0aXZlTG9jYWxlRm9ybWF0dGVyKHRoaXMubG9jYWxlLCB7IHdlZWtkYXk6ICduYXJyb3cnLCB0aW1lWm9uZTogJ1VUQycgfSlcclxuICAgIH0sXHJcbiAgICB3ZWVrRGF5cyAoKTogc3RyaW5nW10ge1xyXG4gICAgICBjb25zdCBmaXJzdCA9IHBhcnNlSW50KHRoaXMuZmlyc3REYXlPZldlZWssIDEwKVxyXG5cclxuICAgICAgcmV0dXJuIHRoaXMud2Vla2RheUZvcm1hdHRlclxyXG4gICAgICAgID8gY3JlYXRlUmFuZ2UoNykubWFwKGkgPT4gdGhpcy53ZWVrZGF5Rm9ybWF0dGVyIShgMjAxNy0wMS0ke2ZpcnN0ICsgaSArIDE1fWApKSAvLyAyMDE3LTAxLTE1IGlzIFN1bmRheVxyXG4gICAgICAgIDogY3JlYXRlUmFuZ2UoNykubWFwKGkgPT4gWydTJywgJ00nLCAnVCcsICdXJywgJ1QnLCAnRicsICdTJ11bKGkgKyBmaXJzdCkgJSA3XSlcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBtZXRob2RzOiB7XHJcbiAgICBjYWxjdWxhdGVUYWJsZURhdGUgKGRlbHRhOiBudW1iZXIpIHtcclxuICAgICAgcmV0dXJuIG1vbnRoQ2hhbmdlKHRoaXMudGFibGVEYXRlLCBNYXRoLnNpZ24oZGVsdGEgfHwgMSkpXHJcbiAgICB9LFxyXG4gICAgZ2VuVEhlYWQgKCkge1xyXG4gICAgICBjb25zdCBkYXlzID0gdGhpcy53ZWVrRGF5cy5tYXAoZGF5ID0+IHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RoJywgZGF5KSlcclxuICAgICAgdGhpcy5zaG93V2VlayAmJiBkYXlzLnVuc2hpZnQodGhpcy4kY3JlYXRlRWxlbWVudCgndGgnKSlcclxuICAgICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RoZWFkJywgdGhpcy5nZW5UUihkYXlzKSlcclxuICAgIH0sXHJcbiAgICAvLyBSZXR1cm5zIG51bWJlciBvZiB0aGUgZGF5cyBmcm9tIHRoZSBmaXJzdERheU9mV2VlayB0byB0aGUgZmlyc3QgZGF5IG9mIHRoZSBjdXJyZW50IG1vbnRoXHJcbiAgICB3ZWVrRGF5c0JlZm9yZUZpcnN0RGF5T2ZUaGVNb250aCAoKSB7XHJcbiAgICAgIGNvbnN0IGZpcnN0RGF5T2ZUaGVNb250aCA9IG5ldyBEYXRlKGAke3RoaXMuZGlzcGxheWVkWWVhcn0tJHtwYWQodGhpcy5kaXNwbGF5ZWRNb250aCArIDEpfS0wMVQwMDowMDowMCswMDowMGApXHJcbiAgICAgIGNvbnN0IHdlZWtEYXkgPSBmaXJzdERheU9mVGhlTW9udGguZ2V0VVRDRGF5KClcclxuICAgICAgcmV0dXJuICh3ZWVrRGF5IC0gcGFyc2VJbnQodGhpcy5maXJzdERheU9mV2VlaykgKyA3KSAlIDdcclxuICAgIH0sXHJcbiAgICBnZXRXZWVrTnVtYmVyICgpIHtcclxuICAgICAgbGV0IGRheU9mWWVhciA9IFswLCAzMSwgNTksIDkwLCAxMjAsIDE1MSwgMTgxLCAyMTIsIDI0MywgMjczLCAzMDQsIDMzNF1bdGhpcy5kaXNwbGF5ZWRNb250aF1cclxuICAgICAgaWYgKHRoaXMuZGlzcGxheWVkTW9udGggPiAxICYmXHJcbiAgICAgICAgKCgodGhpcy5kaXNwbGF5ZWRZZWFyICUgNCA9PT0gMCkgJiYgKHRoaXMuZGlzcGxheWVkWWVhciAlIDEwMCAhPT0gMCkpIHx8ICh0aGlzLmRpc3BsYXllZFllYXIgJSA0MDAgPT09IDApKVxyXG4gICAgICApIHtcclxuICAgICAgICBkYXlPZlllYXIrK1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IG9mZnNldCA9IChcclxuICAgICAgICB0aGlzLmRpc3BsYXllZFllYXIgK1xyXG4gICAgICAgICgodGhpcy5kaXNwbGF5ZWRZZWFyIC0gMSkgPj4gMikgLVxyXG4gICAgICAgIE1hdGguZmxvb3IoKHRoaXMuZGlzcGxheWVkWWVhciAtIDEpIC8gMTAwKSArXHJcbiAgICAgICAgTWF0aC5mbG9vcigodGhpcy5kaXNwbGF5ZWRZZWFyIC0gMSkgLyA0MDApIC1cclxuICAgICAgICBOdW1iZXIodGhpcy5maXJzdERheU9mV2VlaylcclxuICAgICAgKSAlIDcgLy8gaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvWmVsbGVyJTI3c19jb25ncnVlbmNlXHJcbiAgICAgIHJldHVybiBNYXRoLmZsb29yKChkYXlPZlllYXIgKyBvZmZzZXQpIC8gNykgKyAxXHJcbiAgICB9LFxyXG4gICAgZ2VuV2Vla051bWJlciAod2Vla051bWJlcjogbnVtYmVyKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCd0ZCcsIFtcclxuICAgICAgICB0aGlzLiRjcmVhdGVFbGVtZW50KCdzbWFsbCcsIHtcclxuICAgICAgICAgIHN0YXRpY0NsYXNzOiAndi1kYXRlLXBpY2tlci10YWJsZS0tZGF0ZV9fd2VlaydcclxuICAgICAgICB9LCBTdHJpbmcod2Vla051bWJlcikucGFkU3RhcnQoMiwgJzAnKSlcclxuICAgICAgXSlcclxuICAgIH0sXHJcbiAgICBnZW5UQm9keSAoKSB7XHJcbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gW11cclxuICAgICAgY29uc3QgZGF5c0luTW9udGggPSBuZXcgRGF0ZSh0aGlzLmRpc3BsYXllZFllYXIsIHRoaXMuZGlzcGxheWVkTW9udGggKyAxLCAwKS5nZXREYXRlKClcclxuICAgICAgbGV0IHJvd3MgPSBbXVxyXG4gICAgICBsZXQgZGF5ID0gdGhpcy53ZWVrRGF5c0JlZm9yZUZpcnN0RGF5T2ZUaGVNb250aCgpXHJcbiAgICAgIGxldCB3ZWVrTnVtYmVyID0gdGhpcy5nZXRXZWVrTnVtYmVyKClcclxuXHJcbiAgICAgIHRoaXMuc2hvd1dlZWsgJiYgcm93cy5wdXNoKHRoaXMuZ2VuV2Vla051bWJlcih3ZWVrTnVtYmVyKyspKVxyXG5cclxuICAgICAgd2hpbGUgKGRheS0tKSByb3dzLnB1c2godGhpcy4kY3JlYXRlRWxlbWVudCgndGQnKSlcclxuICAgICAgZm9yIChkYXkgPSAxOyBkYXkgPD0gZGF5c0luTW9udGg7IGRheSsrKSB7XHJcbiAgICAgICAgY29uc3QgZGF0ZSA9IGAke3RoaXMuZGlzcGxheWVkWWVhcn0tJHtwYWQodGhpcy5kaXNwbGF5ZWRNb250aCArIDEpfS0ke3BhZChkYXkpfWBcclxuXHJcbiAgICAgICAgcm93cy5wdXNoKHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RkJywgW1xyXG4gICAgICAgICAgdGhpcy5nZW5CdXR0b24oZGF0ZSwgdHJ1ZSwgJ2RhdGUnLCB0aGlzLmZvcm1hdHRlcilcclxuICAgICAgICBdKSlcclxuXHJcbiAgICAgICAgaWYgKHJvd3MubGVuZ3RoICUgKHRoaXMuc2hvd1dlZWsgPyA4IDogNykgPT09IDApIHtcclxuICAgICAgICAgIGNoaWxkcmVuLnB1c2godGhpcy5nZW5UUihyb3dzKSlcclxuICAgICAgICAgIHJvd3MgPSBbXVxyXG4gICAgICAgICAgZGF5IDwgZGF5c0luTW9udGggJiYgdGhpcy5zaG93V2VlayAmJiByb3dzLnB1c2godGhpcy5nZW5XZWVrTnVtYmVyKHdlZWtOdW1iZXIrKykpXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAocm93cy5sZW5ndGgpIHtcclxuICAgICAgICBjaGlsZHJlbi5wdXNoKHRoaXMuZ2VuVFIocm93cykpXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCd0Ym9keScsIGNoaWxkcmVuKVxyXG4gICAgfSxcclxuICAgIGdlblRSIChjaGlsZHJlbjogVk5vZGVDaGlsZHJlbikge1xyXG4gICAgICByZXR1cm4gW3RoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RyJywgY2hpbGRyZW4pXVxyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIHJlbmRlciAoKTogVk5vZGUge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2VuVGFibGUoJ3YtZGF0ZS1waWNrZXItdGFibGUgdi1kYXRlLXBpY2tlci10YWJsZS0tZGF0ZScsIFtcclxuICAgICAgdGhpcy5nZW5USGVhZCgpLFxyXG4gICAgICB0aGlzLmdlblRCb2R5KClcclxuICAgIF0sIHRoaXMuY2FsY3VsYXRlVGFibGVEYXRlKVxyXG4gIH1cclxufSlcclxuIl19