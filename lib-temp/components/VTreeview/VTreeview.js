// Styles
import '../../stylus/components/_treeview.styl';
// Components
import VTreeviewNode, { VTreeviewNodeProps } from './VTreeviewNode';
// Mixins
import Themeable from '../../mixins/themeable';
import { provide as RegistrableProvide } from '../../mixins/registrable';
// Utils
import { arrayDiff, deepEqual, getObjectValueByPath } from '../../util/helpers';
import mixins from '../../util/mixins';
import { consoleWarn } from '../../util/console';
import { filterTreeItems, filterTreeItem } from './util/filterTreeItems';
export default mixins(RegistrableProvide('treeview'), Themeable
/* @vue/component */
).extend({
    name: 'v-treeview',
    provide() {
        return { treeview: this };
    },
    props: {
        active: {
            type: Array,
            default: () => ([])
        },
        items: {
            type: Array,
            default: () => ([])
        },
        hoverable: Boolean,
        multipleActive: Boolean,
        open: {
            type: Array,
            default: () => ([])
        },
        openAll: Boolean,
        returnObject: {
            type: Boolean,
            default: false // TODO: Should be true in next major
        },
        value: {
            type: Array,
            default: () => ([])
        },
        search: String,
        filter: Function,
        ...VTreeviewNodeProps
    },
    data: () => ({
        nodes: {},
        selectedCache: new Set(),
        activeCache: new Set(),
        openCache: new Set()
    }),
    computed: {
        excludedItems() {
            const excluded = new Set();
            if (!this.search)
                return excluded;
            for (let i = 0; i < this.items.length; i++) {
                filterTreeItems(this.filter || filterTreeItem, this.items[i], this.search, this.itemKey, this.itemText, this.itemChildren, excluded);
            }
            return excluded;
        }
    },
    watch: {
        items: {
            handler() {
                const oldKeys = Object.keys(this.nodes).map(k => getObjectValueByPath(this.nodes[k].item, this.itemKey));
                const newKeys = this.getKeys(this.items);
                const diff = arrayDiff(newKeys, oldKeys);
                // We only want to do stuff if items have changed
                if (!diff.length && newKeys.length < oldKeys.length)
                    return;
                // If nodes are removed we need to clear them from this.nodes
                diff.forEach(k => delete this.nodes[k]);
                const oldSelectedCache = [...this.selectedCache];
                this.selectedCache = new Set();
                this.activeCache = new Set();
                this.openCache = new Set();
                this.buildTree(this.items);
                // Only emit selected if selection has changed
                // as a result of items changing. This fixes a
                // potential double emit when selecting a node
                // with dynamic children
                if (!deepEqual(oldSelectedCache, [...this.selectedCache]))
                    this.emitSelected();
            },
            deep: true
        },
        active(value) {
            this.handleNodeCacheWatcher(value, this.activeCache, this.updateActive, this.emitActive);
        },
        value(value) {
            this.handleNodeCacheWatcher(value, this.selectedCache, this.updateSelected, this.emitSelected);
        },
        open(value) {
            this.handleNodeCacheWatcher(value, this.openCache, this.updateOpen, this.emitOpen);
        }
    },
    created() {
        this.buildTree(this.items);
        this.value.forEach(key => this.updateSelected(key, true));
        this.emitSelected();
        this.active.forEach(key => this.updateActive(key, true));
        this.emitActive();
    },
    mounted() {
        // Save the developer from themselves
        if (this.$slots.prepend || this.$slots.append) {
            consoleWarn('The prepend and append slots require a slot-scope attribute', this);
        }
        if (this.openAll) {
            this.updateAll(true);
        }
        else {
            this.open.forEach(key => this.updateOpen(key, true));
            this.emitOpen();
        }
    },
    methods: {
        /** @public */
        updateAll(value) {
            Object.keys(this.nodes).forEach(key => this.updateOpen(getObjectValueByPath(this.nodes[key].item, this.itemKey), value));
            this.emitOpen();
        },
        getKeys(items, keys = []) {
            for (let i = 0; i < items.length; i++) {
                const key = getObjectValueByPath(items[i], this.itemKey);
                keys.push(key);
                const children = getObjectValueByPath(items[i], this.itemChildren);
                if (children) {
                    keys.push(...this.getKeys(children));
                }
            }
            return keys;
        },
        buildTree(items, parent = null) {
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const key = getObjectValueByPath(item, this.itemKey);
                const children = getObjectValueByPath(item, this.itemChildren, []);
                const oldNode = this.nodes.hasOwnProperty(key) ? this.nodes[key] : {
                    isSelected: false, isIndeterminate: false, isActive: false, isOpen: false, vnode: null
                };
                const node = {
                    vnode: oldNode.vnode,
                    parent,
                    children: children.map((c) => getObjectValueByPath(c, this.itemKey)),
                    item
                };
                this.buildTree(children, key);
                // This fixed bug with dynamic children resetting selected parent state
                if (!this.nodes.hasOwnProperty(key) && parent !== null && this.nodes.hasOwnProperty(parent)) {
                    node.isSelected = this.nodes[parent].isSelected;
                    node.isIndeterminate = this.nodes[parent].isIndeterminate;
                }
                else {
                    node.isSelected = oldNode.isSelected;
                    node.isIndeterminate = oldNode.isIndeterminate;
                }
                node.isActive = oldNode.isActive;
                node.isOpen = oldNode.isOpen;
                this.nodes[key] = !children.length ? node : this.calculateState(node, this.nodes);
                // Don't forget to rebuild cache
                if (this.nodes[key].isSelected)
                    this.selectedCache.add(key);
                if (this.nodes[key].isActive)
                    this.activeCache.add(key);
                if (this.nodes[key].isOpen)
                    this.openCache.add(key);
                this.updateVnodeState(key);
            }
        },
        calculateState(node, state) {
            const counts = node.children.reduce((counts, child) => {
                counts[0] += +Boolean(state[child].isSelected);
                counts[1] += +Boolean(state[child].isIndeterminate);
                return counts;
            }, [0, 0]);
            node.isSelected = !!node.children.length && counts[0] === node.children.length;
            node.isIndeterminate = !node.isSelected && (counts[0] > 0 || counts[1] > 0);
            return node;
        },
        emitOpen() {
            this.emitNodeCache('update:open', this.openCache);
        },
        emitSelected() {
            this.emitNodeCache('input', this.selectedCache);
        },
        emitActive() {
            this.emitNodeCache('update:active', this.activeCache);
        },
        emitNodeCache(event, cache) {
            this.$emit(event, this.returnObject ? [...cache].map(key => this.nodes[key].item) : [...cache]);
        },
        handleNodeCacheWatcher(value, cache, updateFn, emitFn) {
            value = this.returnObject ? value.map(v => getObjectValueByPath(v, this.itemKey)) : value;
            const old = [...cache];
            if (deepEqual(old, value))
                return;
            old.forEach(key => updateFn(key, false));
            value.forEach(key => updateFn(key, true));
            emitFn();
        },
        getDescendants(key, descendants = []) {
            const children = this.nodes[key].children;
            descendants.push(...children);
            for (let i = 0; i < children.length; i++) {
                descendants = this.getDescendants(children[i], descendants);
            }
            return descendants;
        },
        getParents(key) {
            let parent = this.nodes[key].parent;
            const parents = [];
            while (parent !== null) {
                parents.push(parent);
                parent = this.nodes[parent].parent;
            }
            return parents;
        },
        register(node) {
            const key = getObjectValueByPath(node.item, this.itemKey);
            this.nodes[key].vnode = node;
            this.updateVnodeState(key);
        },
        unregister(node) {
            const key = getObjectValueByPath(node.item, this.itemKey);
            if (this.nodes[key])
                this.nodes[key].vnode = null;
        },
        updateActive(key, isActive) {
            if (!this.nodes.hasOwnProperty(key))
                return;
            if (!this.multipleActive) {
                this.activeCache.forEach(active => {
                    this.nodes[active].isActive = false;
                    this.updateVnodeState(active);
                    this.activeCache.delete(active);
                });
            }
            const node = this.nodes[key];
            if (!node)
                return;
            if (isActive)
                this.activeCache.add(key);
            else
                this.activeCache.delete(key);
            node.isActive = isActive;
            this.updateVnodeState(key);
        },
        updateSelected(key, isSelected) {
            if (!this.nodes.hasOwnProperty(key))
                return;
            const changed = new Map();
            const descendants = [key, ...this.getDescendants(key)];
            descendants.forEach(descendant => {
                this.nodes[descendant].isSelected = isSelected;
                this.nodes[descendant].isIndeterminate = false;
                changed.set(descendant, isSelected);
            });
            const parents = this.getParents(key);
            parents.forEach(parent => {
                this.nodes[parent] = this.calculateState(this.nodes[parent], this.nodes);
                changed.set(parent, this.nodes[parent].isSelected);
            });
            const all = [key, ...descendants, ...parents];
            all.forEach(this.updateVnodeState);
            for (const [key, value] of changed.entries()) {
                value === true ? this.selectedCache.add(key) : this.selectedCache.delete(key);
            }
        },
        updateOpen(key, isOpen) {
            if (!this.nodes.hasOwnProperty(key))
                return;
            const node = this.nodes[key];
            const children = getObjectValueByPath(node.item, this.itemChildren);
            if (children && !children.length && node.vnode && !node.vnode.hasLoaded) {
                node.vnode.checkChildren().then(() => this.updateOpen(key, isOpen));
            }
            else if (children && children.length) {
                node.isOpen = isOpen;
                node.isOpen ? this.openCache.add(key) : this.openCache.delete(key);
                this.updateVnodeState(key);
            }
        },
        updateVnodeState(key) {
            const node = this.nodes[key];
            if (node && node.vnode) {
                node.vnode.isSelected = node.isSelected;
                node.vnode.isIndeterminate = node.isIndeterminate;
                node.vnode.isActive = node.isActive;
                node.vnode.isOpen = node.isOpen;
            }
        },
        isExcluded(key) {
            return !!this.search && this.excludedItems.has(key);
        }
    },
    render(h) {
        const children = this.items.length
            ? this.items.map(VTreeviewNode.options.methods.genChild.bind(this))
            /* istanbul ignore next */
            : this.$slots.default; // TODO: remove type annotation with TS 3.2
        return h('div', {
            staticClass: 'v-treeview',
            class: {
                'v-treeview--hoverable': this.hoverable,
                ...this.themeClasses
            }
        }, children);
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlRyZWV2aWV3LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVlRyZWV2aWV3L1ZUcmVldmlldy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTyx3Q0FBd0MsQ0FBQTtBQU0vQyxhQUFhO0FBQ2IsT0FBTyxhQUFhLEVBQUUsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlCQUFpQixDQUFBO0FBRW5FLFNBQVM7QUFDVCxPQUFPLFNBQVMsTUFBTSx3QkFBd0IsQ0FBQTtBQUM5QyxPQUFPLEVBQUUsT0FBTyxJQUFJLGtCQUFrQixFQUFFLE1BQU0sMEJBQTBCLENBQUE7QUFFeEUsUUFBUTtBQUNSLE9BQU8sRUFDTCxTQUFTLEVBQ1QsU0FBUyxFQUNULG9CQUFvQixFQUNyQixNQUFNLG9CQUFvQixDQUFBO0FBQzNCLE9BQU8sTUFBTSxNQUFNLG1CQUFtQixDQUFBO0FBQ3RDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUNoRCxPQUFPLEVBQ0wsZUFBZSxFQUVmLGNBQWMsRUFDZixNQUFNLHdCQUF3QixDQUFBO0FBa0IvQixlQUFlLE1BQU0sQ0FDbkIsa0JBQWtCLENBQUMsVUFBVSxDQUFDLEVBQzlCLFNBQVM7QUFDVCxvQkFBb0I7Q0FDckIsQ0FBQyxNQUFNLENBQUM7SUFDUCxJQUFJLEVBQUUsWUFBWTtJQUVsQixPQUFPO1FBQ0wsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQTtJQUMzQixDQUFDO0lBRUQsS0FBSyxFQUFFO1FBQ0wsTUFBTSxFQUFFO1lBQ04sSUFBSSxFQUFFLEtBQUs7WUFDWCxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUM7U0FDUTtRQUM3QixLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsS0FBSztZQUNYLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztTQUNJO1FBQ3pCLFNB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RTtnQkFDTCx1QkFBdUIsRUFBRSxJQUFJLENBQUMsU0FBUztnQkFDdkMsR0FBRyxJQUFJLENBQUMsWUFBWTthQUNyQjtTQUNGLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDZCxDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU3R5bGVzXHJcbmltcG9ydCAnLi4vLi4vc3R5bHVzL2NvbXBvbmVudHMvX3RyZWV2aWV3LnN0eWwnXHJcblxyXG4vLyBUeXBlc1xyXG5pbXBvcnQgeyBWTm9kZSwgVk5vZGVDaGlsZHJlbkFycmF5Q29udGVudHMgfSBmcm9tICd2dWUnXHJcbmltcG9ydCB7IFByb3BWYWxpZGF0b3IgfSBmcm9tICd2dWUvdHlwZXMvb3B0aW9ucydcclxuXHJcbi8vIENvbXBvbmVudHNcclxuaW1wb3J0IFZUcmVldmlld05vZGUsIHsgVlRyZWV2aWV3Tm9kZVByb3BzIH0gZnJvbSAnLi9WVHJlZXZpZXdOb2RlJ1xyXG5cclxuLy8gTWl4aW5zXHJcbmltcG9ydCBUaGVtZWFibGUgZnJvbSAnLi4vLi4vbWl4aW5zL3RoZW1lYWJsZSdcclxuaW1wb3J0IHsgcHJvdmlkZSBhcyBSZWdpc3RyYWJsZVByb3ZpZGUgfSBmcm9tICcuLi8uLi9taXhpbnMvcmVnaXN0cmFibGUnXHJcblxyXG4vLyBVdGlsc1xyXG5pbXBvcnQge1xyXG4gIGFycmF5RGlmZixcclxuICBkZWVwRXF1YWwsXHJcbiAgZ2V0T2JqZWN0VmFsdWVCeVBhdGhcclxufSBmcm9tICcuLi8uLi91dGlsL2hlbHBlcnMnXHJcbmltcG9ydCBtaXhpbnMgZnJvbSAnLi4vLi4vdXRpbC9taXhpbnMnXHJcbmltcG9ydCB7IGNvbnNvbGVXYXJuIH0gZnJvbSAnLi4vLi4vdXRpbC9jb25zb2xlJ1xyXG5pbXBvcnQge1xyXG4gIGZpbHRlclRyZWVJdGVtcyxcclxuICBGaWx0ZXJUcmVlSXRlbUZ1bmN0aW9uLFxyXG4gIGZpbHRlclRyZWVJdGVtXHJcbn0gZnJvbSAnLi91dGlsL2ZpbHRlclRyZWVJdGVtcydcclxuXHJcbnR5cGUgVlRyZWV2aWV3Tm9kZUluc3RhbmNlID0gSW5zdGFuY2VUeXBlPHR5cGVvZiBWVHJlZXZpZXdOb2RlPlxyXG5cclxudHlwZSBOb2RlQ2FjaGUgPSBTZXQ8c3RyaW5nIHwgbnVtYmVyPlxyXG50eXBlIE5vZGVBcnJheSA9IChzdHJpbmcgfCBudW1iZXIpW11cclxuXHJcbnR5cGUgTm9kZVN0YXRlID0ge1xyXG4gIHBhcmVudDogbnVtYmVyIHwgc3RyaW5nIHwgbnVsbFxyXG4gIGNoaWxkcmVuOiAobnVtYmVyIHwgc3RyaW5nKVtdXHJcbiAgdm5vZGU6IFZUcmVldmlld05vZGVJbnN0YW5jZSB8IG51bGxcclxuICBpc0FjdGl2ZTogYm9vbGVhblxyXG4gIGlzU2VsZWN0ZWQ6IGJvb2xlYW5cclxuICBpc0luZGV0ZXJtaW5hdGU6IGJvb2xlYW5cclxuICBpc09wZW46IGJvb2xlYW5cclxuICBpdGVtOiBhbnlcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgbWl4aW5zKFxyXG4gIFJlZ2lzdHJhYmxlUHJvdmlkZSgndHJlZXZpZXcnKSxcclxuICBUaGVtZWFibGVcclxuICAvKiBAdnVlL2NvbXBvbmVudCAqL1xyXG4pLmV4dGVuZCh7XHJcbiAgbmFtZTogJ3YtdHJlZXZpZXcnLFxyXG5cclxuICBwcm92aWRlICgpOiBvYmplY3Qge1xyXG4gICAgcmV0dXJuIHsgdHJlZXZpZXc6IHRoaXMgfVxyXG4gIH0sXHJcblxyXG4gIHByb3BzOiB7XHJcbiAgICBhY3RpdmU6IHtcclxuICAgICAgdHlwZTogQXJyYXksXHJcbiAgICAgIGRlZmF1bHQ6ICgpID0+IChbXSlcclxuICAgIH0gYXMgUHJvcFZhbGlkYXRvcjxOb2RlQXJyYXk+LFxyXG4gICAgaXRlbXM6IHtcclxuICAgICAgdHlwZTogQXJyYXksXHJcbiAgICAgIGRlZmF1bHQ6ICgpID0+IChbXSlcclxuICAgIH0gYXMgUHJvcFZhbGlkYXRvcjxhbnlbXT4sXHJcbiAgICBob3ZlcmFibGU6IEJvb2xlYW4sXHJcbiAgICBtdWx0aXBsZUFjdGl2ZTogQm9vbGVhbixcclxuICAgIG9wZW46IHtcclxuICAgICAgdHlwZTogQXJyYXksXHJcbiAgICAgIGRlZmF1bHQ6ICgpID0+IChbXSlcclxuICAgIH0gYXMgUHJvcFZhbGlkYXRvcjxOb2RlQXJyYXk+LFxyXG4gICAgb3BlbkFsbDogQm9vbGVhbixcclxuICAgIHJldHVybk9iamVjdDoge1xyXG4gICAgICB0eXBlOiBCb29sZWFuLFxyXG4gICAgICBkZWZhdWx0OiBmYWxzZSAvLyBUT0RPOiBTaG91bGQgYmUgdHJ1ZSBpbiBuZXh0IG1ham9yXHJcbiAgICB9LFxyXG4gICAgdmFsdWU6IHtcclxuICAgICAgdHlwZTogQXJyYXksXHJcbiAgICAgIGRlZmF1bHQ6ICgpID0+IChbXSlcclxuICAgIH0gYXMgUHJvcFZhbGlkYXRvcjxOb2RlQXJyYXk+LFxyXG4gICAgc2VhcmNoOiBTdHJpbmcsXHJcbiAgICBmaWx0ZXI6IEZ1bmN0aW9uIGFzIFByb3BWYWxpZGF0b3I8RmlsdGVyVHJlZUl0ZW1GdW5jdGlvbj4sXHJcbiAgICAuLi5WVHJlZXZpZXdOb2RlUHJvcHNcclxuICB9LFxyXG5cclxuICBkYXRhOiAoKSA9PiAoe1xyXG4gICAgbm9kZXM6IHt9IGFzIFJlY29yZDxzdHJpbmcgfCBudW1iZXIsIE5vZGVTdGF0ZT4sXHJcbiAgICBzZWxlY3RlZENhY2hlOiBuZXcgU2V0KCkgYXMgTm9kZUNhY2hlLFxyXG4gICAgYWN0aXZlQ2FjaGU6IG5ldyBTZXQoKSBhcyBOb2RlQ2FjaGUsXHJcbiAgICBvcGVuQ2FjaGU6IG5ldyBTZXQoKSBhcyBOb2RlQ2FjaGVcclxuICB9KSxcclxuXHJcbiAgY29tcHV0ZWQ6IHtcclxuICAgIGV4Y2x1ZGVkSXRlbXMgKCk6IFNldDxzdHJpbmcgfCBudW1iZXI+IHtcclxuICAgICAgY29uc3QgZXhjbHVkZWQgPSBuZXcgU2V0PHN0cmluZ3xudW1iZXI+KClcclxuXHJcbiAgICAgIGlmICghdGhpcy5zZWFyY2gpIHJldHVybiBleGNsdWRlZFxyXG5cclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLml0ZW1zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgZmlsdGVyVHJlZUl0ZW1zKFxyXG4gICAgICAgICAgdGhpcy5maWx0ZXIgfHwgZmlsdGVyVHJlZUl0ZW0sXHJcbiAgICAgICAgICB0aGlzLml0ZW1zW2ldLFxyXG4gICAgICAgICAgdGhpcy5zZWFyY2gsXHJcbiAgICAgICAgICB0aGlzLml0ZW1LZXksXHJcbiAgICAgICAgICB0aGlzLml0ZW1UZXh0LFxyXG4gICAgICAgICAgdGhpcy5pdGVtQ2hpbGRyZW4sXHJcbiAgICAgICAgICBleGNsdWRlZFxyXG4gICAgICAgIClcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIGV4Y2x1ZGVkXHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgd2F0Y2g6IHtcclxuICAgIGl0ZW1zOiB7XHJcbiAgICAgIGhhbmRsZXIgKCkge1xyXG4gICAgICAgIGNvbnN0IG9sZEtleXMgPSBPYmplY3Qua2V5cyh0aGlzLm5vZGVzKS5tYXAoayA9PiBnZXRPYmplY3RWYWx1ZUJ5UGF0aCh0aGlzLm5vZGVzW2tdLml0ZW0sIHRoaXMuaXRlbUtleSkpXHJcbiAgICAgICAgY29uc3QgbmV3S2V5cyA9IHRoaXMuZ2V0S2V5cyh0aGlzLml0ZW1zKVxyXG4gICAgICAgIGNvbnN0IGRpZmYgPSBhcnJheURpZmYobmV3S2V5cywgb2xkS2V5cylcclxuXHJcbiAgICAgICAgLy8gV2Ugb25seSB3YW50IHRvIGRvIHN0dWZmIGlmIGl0ZW1zIGhhdmUgY2hhbmdlZFxyXG4gICAgICAgIGlmICghZGlmZi5sZW5ndGggJiYgbmV3S2V5cy5sZW5ndGggPCBvbGRLZXlzLmxlbmd0aCkgcmV0dXJuXHJcblxyXG4gICAgICAgIC8vIElmIG5vZGVzIGFyZSByZW1vdmVkIHdlIG5lZWQgdG8gY2xlYXIgdGhlbSBmcm9tIHRoaXMubm9kZXNcclxuICAgICAgICBkaWZmLmZvckVhY2goayA9PiBkZWxldGUgdGhpcy5ub2Rlc1trXSlcclxuXHJcbiAgICAgICAgY29uc3Qgb2xkU2VsZWN0ZWRDYWNoZSA9IFsuLi50aGlzLnNlbGVjdGVkQ2FjaGVdXHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZENhY2hlID0gbmV3IFNldCgpXHJcbiAgICAgICAgdGhpcy5hY3RpdmVDYWNoZSA9IG5ldyBTZXQoKVxyXG4gICAgICAgIHRoaXMub3BlbkNhY2hlID0gbmV3IFNldCgpXHJcbiAgICAgICAgdGhpcy5idWlsZFRyZWUodGhpcy5pdGVtcylcclxuXHJcbiAgICAgICAgLy8gT25seSBlbWl0IHNlbGVjdGVkIGlmIHNlbGVjdGlvbiBoYXMgY2hhbmdlZFxyXG4gICAgICAgIC8vIGFzIGEgcmVzdWx0IG9mIGl0ZW1zIGNoYW5naW5nLiBUaGlzIGZpeGVzIGFcclxuICAgICAgICAvLyBwb3RlbnRpYWwgZG91YmxlIGVtaXQgd2hlbiBzZWxlY3RpbmcgYSBub2RlXHJcbiAgICAgICAgLy8gd2l0aCBkeW5hbWljIGNoaWxkcmVuXHJcbiAgICAgICAgaWYgKCFkZWVwRXF1YWwob2xkU2VsZWN0ZWRDYWNoZSwgWy4uLnRoaXMuc2VsZWN0ZWRDYWNoZV0pKSB0aGlzLmVtaXRTZWxlY3RlZCgpXHJcbiAgICAgIH0sXHJcbiAgICAgIGRlZXA6IHRydWVcclxuICAgIH0sXHJcbiAgICBhY3RpdmUgKHZhbHVlOiAoc3RyaW5nIHwgbnVtYmVyIHwgYW55KVtdKSB7XHJcbiAgICAgIHRoaXMuaGFuZGxlTm9kZUNhY2hlV2F0Y2hlcih2YWx1ZSwgdGhpcy5hY3RpdmVDYWNoZSwgdGhpcy51cGRhdGVBY3RpdmUsIHRoaXMuZW1pdEFjdGl2ZSlcclxuICAgIH0sXHJcbiAgICB2YWx1ZSAodmFsdWU6IChzdHJpbmcgfCBudW1iZXIgfCBhbnkpW10pIHtcclxuICAgICAgdGhpcy5oYW5kbGVOb2RlQ2FjaGVXYXRjaGVyKHZhbHVlLCB0aGlzLnNlbGVjdGVkQ2FjaGUsIHRoaXMudXBkYXRlU2VsZWN0ZWQsIHRoaXMuZW1pdFNlbGVjdGVkKVxyXG4gICAgfSxcclxuICAgIG9wZW4gKHZhbHVlOiAoc3RyaW5nIHwgbnVtYmVyIHwgYW55KVtdKSB7XHJcbiAgICAgIHRoaXMuaGFuZGxlTm9kZUNhY2hlV2F0Y2hlcih2YWx1ZSwgdGhpcy5vcGVuQ2FjaGUsIHRoaXMudXBkYXRlT3BlbiwgdGhpcy5lbWl0T3BlbilcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBjcmVhdGVkICgpIHtcclxuICAgIHRoaXMuYnVpbGRUcmVlKHRoaXMuaXRlbXMpXHJcbiAgICB0aGlzLnZhbHVlLmZvckVhY2goa2V5ID0+IHRoaXMudXBkYXRlU2VsZWN0ZWQoa2V5LCB0cnVlKSlcclxuICAgIHRoaXMuZW1pdFNlbGVjdGVkKClcclxuICAgIHRoaXMuYWN0aXZlLmZvckVhY2goa2V5ID0+IHRoaXMudXBkYXRlQWN0aXZlKGtleSwgdHJ1ZSkpXHJcbiAgICB0aGlzLmVtaXRBY3RpdmUoKVxyXG4gIH0sXHJcblxyXG4gIG1vdW50ZWQgKCkge1xyXG4gICAgLy8gU2F2ZSB0aGUgZGV2ZWxvcGVyIGZyb20gdGhlbXNlbHZlc1xyXG4gICAgaWYgKHRoaXMuJHNsb3RzLnByZXBlbmQgfHwgdGhpcy4kc2xvdHMuYXBwZW5kKSB7XHJcbiAgICAgIGNvbnNvbGVXYXJuKCdUaGUgcHJlcGVuZCBhbmQgYXBwZW5kIHNsb3RzIHJlcXVpcmUgYSBzbG90LXNjb3BlIGF0dHJpYnV0ZScsIHRoaXMpXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMub3BlbkFsbCkge1xyXG4gICAgICB0aGlzLnVwZGF0ZUFsbCh0cnVlKVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5vcGVuLmZvckVhY2goa2V5ID0+IHRoaXMudXBkYXRlT3BlbihrZXksIHRydWUpKVxyXG4gICAgICB0aGlzLmVtaXRPcGVuKClcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBtZXRob2RzOiB7XHJcbiAgICAvKiogQHB1YmxpYyAqL1xyXG4gICAgdXBkYXRlQWxsICh2YWx1ZTogYm9vbGVhbikge1xyXG4gICAgICBPYmplY3Qua2V5cyh0aGlzLm5vZGVzKS5mb3JFYWNoKGtleSA9PiB0aGlzLnVwZGF0ZU9wZW4oZ2V0T2JqZWN0VmFsdWVCeVBhdGgodGhpcy5ub2Rlc1trZXldLml0ZW0sIHRoaXMuaXRlbUtleSksIHZhbHVlKSlcclxuICAgICAgdGhpcy5lbWl0T3BlbigpXHJcbiAgICB9LFxyXG4gICAgZ2V0S2V5cyAoaXRlbXM6IGFueVtdLCBrZXlzOiBhbnlbXSA9IFtdKSB7XHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBjb25zdCBrZXkgPSBnZXRPYmplY3RWYWx1ZUJ5UGF0aChpdGVtc1tpXSwgdGhpcy5pdGVtS2V5KVxyXG4gICAgICAgIGtleXMucHVzaChrZXkpXHJcbiAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBnZXRPYmplY3RWYWx1ZUJ5UGF0aChpdGVtc1tpXSwgdGhpcy5pdGVtQ2hpbGRyZW4pXHJcbiAgICAgICAgaWYgKGNoaWxkcmVuKSB7XHJcbiAgICAgICAgICBrZXlzLnB1c2goLi4udGhpcy5nZXRLZXlzKGNoaWxkcmVuKSlcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiBrZXlzXHJcbiAgICB9LFxyXG4gICAgYnVpbGRUcmVlIChpdGVtczogYW55W10sIHBhcmVudDogKHN0cmluZyB8IG51bWJlciB8IG51bGwpID0gbnVsbCkge1xyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgY29uc3QgaXRlbSA9IGl0ZW1zW2ldXHJcbiAgICAgICAgY29uc3Qga2V5ID0gZ2V0T2JqZWN0VmFsdWVCeVBhdGgoaXRlbSwgdGhpcy5pdGVtS2V5KVxyXG4gICAgICAgIGNvbnN0IGNoaWxkcmVuID0gZ2V0T2JqZWN0VmFsdWVCeVBhdGgoaXRlbSwgdGhpcy5pdGVtQ2hpbGRyZW4sIFtdKVxyXG4gICAgICAgIGNvbnN0IG9sZE5vZGUgPSB0aGlzLm5vZGVzLmhhc093blByb3BlcnR5KGtleSkgPyB0aGlzLm5vZGVzW2tleV0gOiB7XHJcbiAgICAgICAgICBpc1NlbGVjdGVkOiBmYWxzZSwgaXNJbmRldGVybWluYXRlOiBmYWxzZSwgaXNBY3RpdmU6IGZhbHNlLCBpc09wZW46IGZhbHNlLCB2bm9kZTogbnVsbFxyXG4gICAgICAgIH0gYXMgTm9kZVN0YXRlXHJcblxyXG4gICAgICAgIGNvbnN0IG5vZGU6IGFueSA9IHtcclxuICAgICAgICAgIHZub2RlOiBvbGROb2RlLnZub2RlLFxyXG4gICAgICAgICAgcGFyZW50LFxyXG4gICAgICAgICAgY2hpbGRyZW46IGNoaWxkcmVuLm1hcCgoYzogYW55KSA9PiBnZXRPYmplY3RWYWx1ZUJ5UGF0aChjLCB0aGlzLml0ZW1LZXkpKSxcclxuICAgICAgICAgIGl0ZW1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuYnVpbGRUcmVlKGNoaWxkcmVuLCBrZXkpXHJcblxyXG4gICAgICAgIC8vIFRoaXMgZml4ZWQgYnVnIHdpdGggZHluYW1pYyBjaGlsZHJlbiByZXNldHRpbmcgc2VsZWN0ZWQgcGFyZW50IHN0YXRlXHJcbiAgICAgICAgaWYgKCF0aGlzLm5vZGVzLmhhc093blByb3BlcnR5KGtleSkgJiYgcGFyZW50ICE9PSBudWxsICYmIHRoaXMubm9kZXMuaGFzT3duUHJvcGVydHkocGFyZW50KSkge1xyXG4gICAgICAgICAgbm9kZS5pc1NlbGVjdGVkID0gdGhpcy5ub2Rlc1twYXJlbnRdLmlzU2VsZWN0ZWRcclxuICAgICAgICAgIG5vZGUuaXNJbmRldGVybWluYXRlID0gdGhpcy5ub2Rlc1twYXJlbnRdLmlzSW5kZXRlcm1pbmF0ZVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBub2RlLmlzU2VsZWN0ZWQgPSBvbGROb2RlLmlzU2VsZWN0ZWRcclxuICAgICAgICAgIG5vZGUuaXNJbmRldGVybWluYXRlID0gb2xkTm9kZS5pc0luZGV0ZXJtaW5hdGVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG5vZGUuaXNBY3RpdmUgPSBvbGROb2RlLmlzQWN0aXZlXHJcbiAgICAgICAgbm9kZS5pc09wZW4gPSBvbGROb2RlLmlzT3BlblxyXG5cclxuICAgICAgICB0aGlzLm5vZGVzW2tleV0gPSAhY2hpbGRyZW4ubGVuZ3RoID8gbm9kZSA6IHRoaXMuY2FsY3VsYXRlU3RhdGUobm9kZSwgdGhpcy5ub2RlcylcclxuXHJcbiAgICAgICAgLy8gRG9uJ3QgZm9yZ2V0IHRvIHJlYnVpbGQgY2FjaGVcclxuICAgICAgICBpZiAodGhpcy5ub2Rlc1trZXldLmlzU2VsZWN0ZWQpIHRoaXMuc2VsZWN0ZWRDYWNoZS5hZGQoa2V5KVxyXG4gICAgICAgIGlmICh0aGlzLm5vZGVzW2tleV0uaXNBY3RpdmUpIHRoaXMuYWN0aXZlQ2FjaGUuYWRkKGtleSlcclxuICAgICAgICBpZiAodGhpcy5ub2Rlc1trZXldLmlzT3BlbikgdGhpcy5vcGVuQ2FjaGUuYWRkKGtleSlcclxuXHJcbiAgICAgICAgdGhpcy51cGRhdGVWbm9kZVN0YXRlKGtleSlcclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIGNhbGN1bGF0ZVN0YXRlIChub2RlOiBOb2RlU3RhdGUsIHN0YXRlOiBSZWNvcmQ8c3RyaW5nIHwgbnVtYmVyLCBOb2RlU3RhdGU+KSB7XHJcbiAgICAgIGNvbnN0IGNvdW50cyA9IG5vZGUuY2hpbGRyZW4ucmVkdWNlKChjb3VudHM6IG51bWJlcltdLCBjaGlsZDogc3RyaW5nIHwgbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgY291bnRzWzBdICs9ICtCb29sZWFuKHN0YXRlW2NoaWxkXS5pc1NlbGVjdGVkKVxyXG4gICAgICAgIGNvdW50c1sxXSArPSArQm9vbGVhbihzdGF0ZVtjaGlsZF0uaXNJbmRldGVybWluYXRlKVxyXG4gICAgICAgIHJldHVybiBjb3VudHNcclxuICAgICAgfSwgWzAsIDBdKVxyXG5cclxuICAgICAgbm9kZS5pc1NlbGVjdGVkID0gISFub2RlLmNoaWxkcmVuLmxlbmd0aCAmJiBjb3VudHNbMF0gPT09IG5vZGUuY2hpbGRyZW4ubGVuZ3RoXHJcbiAgICAgIG5vZGUuaXNJbmRldGVybWluYXRlID0gIW5vZGUuaXNTZWxlY3RlZCAmJiAoY291bnRzWzBdID4gMCB8fCBjb3VudHNbMV0gPiAwKVxyXG5cclxuICAgICAgcmV0dXJuIG5vZGVcclxuICAgIH0sXHJcbiAgICBlbWl0T3BlbiAoKSB7XHJcbiAgICAgIHRoaXMuZW1pdE5vZGVDYWNoZSgndXBkYXRlOm9wZW4nLCB0aGlzLm9wZW5DYWNoZSlcclxuICAgIH0sXHJcbiAgICBlbWl0U2VsZWN0ZWQgKCkge1xyXG4gICAgICB0aGlzLmVtaXROb2RlQ2FjaGUoJ2lucHV0JywgdGhpcy5zZWxlY3RlZENhY2hlKVxyXG4gICAgfSxcclxuICAgIGVtaXRBY3RpdmUgKCkge1xyXG4gICAgICB0aGlzLmVtaXROb2RlQ2FjaGUoJ3VwZGF0ZTphY3RpdmUnLCB0aGlzLmFjdGl2ZUNhY2hlKVxyXG4gICAgfSxcclxuICAgIGVtaXROb2RlQ2FjaGUgKGV2ZW50OiBzdHJpbmcsIGNhY2hlOiBOb2RlQ2FjaGUpIHtcclxuICAgICAgdGhpcy4kZW1pdChldmVudCwgdGhpcy5yZXR1cm5PYmplY3QgPyBbLi4uY2FjaGVdLm1hcChrZXkgPT4gdGhpcy5ub2Rlc1trZXldLml0ZW0pIDogWy4uLmNhY2hlXSlcclxuICAgIH0sXHJcbiAgICBoYW5kbGVOb2RlQ2FjaGVXYXRjaGVyICh2YWx1ZTogYW55W10sIGNhY2hlOiBOb2RlQ2FjaGUsIHVwZGF0ZUZuOiBGdW5jdGlvbiwgZW1pdEZuOiBGdW5jdGlvbikge1xyXG4gICAgICB2YWx1ZSA9IHRoaXMucmV0dXJuT2JqZWN0ID8gdmFsdWUubWFwKHYgPT4gZ2V0T2JqZWN0VmFsdWVCeVBhdGgodiwgdGhpcy5pdGVtS2V5KSkgOiB2YWx1ZVxyXG4gICAgICBjb25zdCBvbGQgPSBbLi4uY2FjaGVdXHJcbiAgICAgIGlmIChkZWVwRXF1YWwob2xkLCB2YWx1ZSkpIHJldHVyblxyXG5cclxuICAgICAgb2xkLmZvckVhY2goa2V5ID0+IHVwZGF0ZUZuKGtleSwgZmFsc2UpKVxyXG4gICAgICB2YWx1ZS5mb3JFYWNoKGtleSA9PiB1cGRhdGVGbihrZXksIHRydWUpKVxyXG5cclxuICAgICAgZW1pdEZuKClcclxuICAgIH0sXHJcbiAgICBnZXREZXNjZW5kYW50cyAoa2V5OiBzdHJpbmcgfCBudW1iZXIsIGRlc2NlbmRhbnRzOiBOb2RlQXJyYXkgPSBbXSkge1xyXG4gICAgICBjb25zdCBjaGlsZHJlbiA9IHRoaXMubm9kZXNba2V5XS5jaGlsZHJlblxyXG5cclxuICAgICAgZGVzY2VuZGFudHMucHVzaCguLi5jaGlsZHJlbilcclxuXHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBkZXNjZW5kYW50cyA9IHRoaXMuZ2V0RGVzY2VuZGFudHMoY2hpbGRyZW5baV0sIGRlc2NlbmRhbnRzKVxyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gZGVzY2VuZGFudHNcclxuICAgIH0sXHJcbiAgICBnZXRQYXJlbnRzIChrZXk6IHN0cmluZyB8IG51bWJlcikge1xyXG4gICAgICBsZXQgcGFyZW50ID0gdGhpcy5ub2Rlc1trZXldLnBhcmVudFxyXG5cclxuICAgICAgY29uc3QgcGFyZW50cyA9IFtdXHJcbiAgICAgIHdoaWxlIChwYXJlbnQgIT09IG51bGwpIHtcclxuICAgICAgICBwYXJlbnRzLnB1c2gocGFyZW50KVxyXG4gICAgICAgIHBhcmVudCA9IHRoaXMubm9kZXNbcGFyZW50XS5wYXJlbnRcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHBhcmVudHNcclxuICAgIH0sXHJcbiAgICByZWdpc3RlciAobm9kZTogVlRyZWV2aWV3Tm9kZUluc3RhbmNlKSB7XHJcbiAgICAgIGNvbnN0IGtleSA9IGdldE9iamVjdFZhbHVlQnlQYXRoKG5vZGUuaXRlbSwgdGhpcy5pdGVtS2V5KVxyXG4gICAgICB0aGlzLm5vZGVzW2tleV0udm5vZGUgPSBub2RlXHJcblxyXG4gICAgICB0aGlzLnVwZGF0ZVZub2RlU3RhdGUoa2V5KVxyXG4gICAgfSxcclxuICAgIHVucmVnaXN0ZXIgKG5vZGU6IFZUcmVldmlld05vZGVJbnN0YW5jZSkge1xyXG4gICAgICBjb25zdCBrZXkgPSBnZXRPYmplY3RWYWx1ZUJ5UGF0aChub2RlLml0ZW0sIHRoaXMuaXRlbUtleSlcclxuICAgICAgaWYgKHRoaXMubm9kZXNba2V5XSkgdGhpcy5ub2Rlc1trZXldLnZub2RlID0gbnVsbFxyXG4gICAgfSxcclxuICAgIHVwZGF0ZUFjdGl2ZSAoa2V5OiBzdHJpbmcgfCBudW1iZXIsIGlzQWN0aXZlOiBib29sZWFuKSB7XHJcbiAgICAgIGlmICghdGhpcy5ub2Rlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXR1cm5cclxuXHJcbiAgICAgIGlmICghdGhpcy5tdWx0aXBsZUFjdGl2ZSkge1xyXG4gICAgICAgIHRoaXMuYWN0aXZlQ2FjaGUuZm9yRWFjaChhY3RpdmUgPT4ge1xyXG4gICAgICAgICAgdGhpcy5ub2Rlc1thY3RpdmVdLmlzQWN0aXZlID0gZmFsc2VcclxuICAgICAgICAgIHRoaXMudXBkYXRlVm5vZGVTdGF0ZShhY3RpdmUpXHJcbiAgICAgICAgICB0aGlzLmFjdGl2ZUNhY2hlLmRlbGV0ZShhY3RpdmUpXHJcbiAgICAgICAgfSlcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZXNba2V5XVxyXG4gICAgICBpZiAoIW5vZGUpIHJldHVyblxyXG5cclxuICAgICAgaWYgKGlzQWN0aXZlKSB0aGlzLmFjdGl2ZUNhY2hlLmFkZChrZXkpXHJcbiAgICAgIGVsc2UgdGhpcy5hY3RpdmVDYWNoZS5kZWxldGUoa2V5KVxyXG5cclxuICAgICAgbm9kZS5pc0FjdGl2ZSA9IGlzQWN0aXZlXHJcblxyXG4gICAgICB0aGlzLnVwZGF0ZVZub2RlU3RhdGUoa2V5KVxyXG4gICAgfSxcclxuICAgIHVwZGF0ZVNlbGVjdGVkIChrZXk6IHN0cmluZyB8IG51bWJlciwgaXNTZWxlY3RlZDogYm9vbGVhbikge1xyXG4gICAgICBpZiAoIXRoaXMubm9kZXMuaGFzT3duUHJvcGVydHkoa2V5KSkgcmV0dXJuXHJcblxyXG4gICAgICBjb25zdCBjaGFuZ2VkID0gbmV3IE1hcCgpXHJcblxyXG4gICAgICBjb25zdCBkZXNjZW5kYW50cyA9IFtrZXksIC4uLnRoaXMuZ2V0RGVzY2VuZGFudHMoa2V5KV1cclxuICAgICAgZGVzY2VuZGFudHMuZm9yRWFjaChkZXNjZW5kYW50ID0+IHtcclxuICAgICAgICB0aGlzLm5vZGVzW2Rlc2NlbmRhbnRdLmlzU2VsZWN0ZWQgPSBpc1NlbGVjdGVkXHJcbiAgICAgICAgdGhpcy5ub2Rlc1tkZXNjZW5kYW50XS5pc0luZGV0ZXJtaW5hdGUgPSBmYWxzZVxyXG4gICAgICAgIGNoYW5nZWQuc2V0KGRlc2NlbmRhbnQsIGlzU2VsZWN0ZWQpXHJcbiAgICAgIH0pXHJcblxyXG4gICAgICBjb25zdCBwYXJlbnRzID0gdGhpcy5nZXRQYXJlbnRzKGtleSlcclxuICAgICAgcGFyZW50cy5mb3JFYWNoKHBhcmVudCA9PiB7XHJcbiAgICAgICAgdGhpcy5ub2Rlc1twYXJlbnRdID0gdGhpcy5jYWxjdWxhdGVTdGF0ZSh0aGlzLm5vZGVzW3BhcmVudF0sIHRoaXMubm9kZXMpXHJcbiAgICAgICAgY2hhbmdlZC5zZXQocGFyZW50LCB0aGlzLm5vZGVzW3BhcmVudF0uaXNTZWxlY3RlZClcclxuICAgICAgfSlcclxuXHJcbiAgICAgIGNvbnN0IGFsbCA9IFtrZXksIC4uLmRlc2NlbmRhbnRzLCAuLi5wYXJlbnRzXVxyXG4gICAgICBhbGwuZm9yRWFjaCh0aGlzLnVwZGF0ZVZub2RlU3RhdGUpXHJcblxyXG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBjaGFuZ2VkLmVudHJpZXMoKSkge1xyXG4gICAgICAgIHZhbHVlID09PSB0cnVlID8gdGhpcy5zZWxlY3RlZENhY2hlLmFkZChrZXkpIDogdGhpcy5zZWxlY3RlZENhY2hlLmRlbGV0ZShrZXkpXHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICB1cGRhdGVPcGVuIChrZXk6IHN0cmluZyB8IG51bWJlciwgaXNPcGVuOiBib29sZWFuKSB7XHJcbiAgICAgIGlmICghdGhpcy5ub2Rlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXR1cm5cclxuXHJcbiAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGVzW2tleV1cclxuICAgICAgY29uc3QgY2hpbGRyZW4gPSBnZXRPYmplY3RWYWx1ZUJ5UGF0aChub2RlLml0ZW0sIHRoaXMuaXRlbUNoaWxkcmVuKVxyXG5cclxuICAgICAgaWYgKGNoaWxkcmVuICYmICFjaGlsZHJlbi5sZW5ndGggJiYgbm9kZS52bm9kZSAmJiAhbm9kZS52bm9kZS5oYXNMb2FkZWQpIHtcclxuICAgICAgICBub2RlLnZub2RlLmNoZWNrQ2hpbGRyZW4oKS50aGVuKCgpID0+IHRoaXMudXBkYXRlT3BlbihrZXksIGlzT3BlbikpXHJcbiAgICAgIH0gZWxzZSBpZiAoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSB7XHJcbiAgICAgICAgbm9kZS5pc09wZW4gPSBpc09wZW5cclxuXHJcbiAgICAgICAgbm9kZS5pc09wZW4gPyB0aGlzLm9wZW5DYWNoZS5hZGQoa2V5KSA6IHRoaXMub3BlbkNhY2hlLmRlbGV0ZShrZXkpXHJcblxyXG4gICAgICAgIHRoaXMudXBkYXRlVm5vZGVTdGF0ZShrZXkpXHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICB1cGRhdGVWbm9kZVN0YXRlIChrZXk6IHN0cmluZyB8IG51bWJlcikge1xyXG4gICAgICBjb25zdCBub2RlID0gdGhpcy5ub2Rlc1trZXldXHJcblxyXG4gICAgICBpZiAobm9kZSAmJiBub2RlLnZub2RlKSB7XHJcbiAgICAgICAgbm9kZS52bm9kZS5pc1NlbGVjdGVkID0gbm9kZS5pc1NlbGVjdGVkXHJcbiAgICAgICAgbm9kZS52bm9kZS5pc0luZGV0ZXJtaW5hdGUgPSBub2RlLmlzSW5kZXRlcm1pbmF0ZVxyXG4gICAgICAgIG5vZGUudm5vZGUuaXNBY3RpdmUgPSBub2RlLmlzQWN0aXZlXHJcbiAgICAgICAgbm9kZS52bm9kZS5pc09wZW4gPSBub2RlLmlzT3BlblxyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgaXNFeGNsdWRlZCAoa2V5OiBzdHJpbmcgfCBudW1iZXIpIHtcclxuICAgICAgcmV0dXJuICEhdGhpcy5zZWFyY2ggJiYgdGhpcy5leGNsdWRlZEl0ZW1zLmhhcyhrZXkpXHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgcmVuZGVyIChoKTogVk5vZGUge1xyXG4gICAgY29uc3QgY2hpbGRyZW46IFZOb2RlQ2hpbGRyZW5BcnJheUNvbnRlbnRzID0gdGhpcy5pdGVtcy5sZW5ndGhcclxuICAgICAgPyB0aGlzLml0ZW1zLm1hcChWVHJlZXZpZXdOb2RlLm9wdGlvbnMubWV0aG9kcy5nZW5DaGlsZC5iaW5kKHRoaXMpKVxyXG4gICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xyXG4gICAgICA6IHRoaXMuJHNsb3RzLmRlZmF1bHQhIC8vIFRPRE86IHJlbW92ZSB0eXBlIGFubm90YXRpb24gd2l0aCBUUyAzLjJcclxuXHJcbiAgICByZXR1cm4gaCgnZGl2Jywge1xyXG4gICAgICBzdGF0aWNDbGFzczogJ3YtdHJlZXZpZXcnLFxyXG4gICAgICBjbGFzczoge1xyXG4gICAgICAgICd2LXRyZWV2aWV3LS1ob3ZlcmFibGUnOiB0aGlzLmhvdmVyYWJsZSxcclxuICAgICAgICAuLi50aGlzLnRoZW1lQ2xhc3Nlc1xyXG4gICAgICB9XHJcbiAgICB9LCBjaGlsZHJlbilcclxuICB9XHJcbn0pXHJcbiJdfQ==