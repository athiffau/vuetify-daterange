// Styles
import '../../stylus/components/_range-sliders.styl';
// Extensions
import VSlider from '../VSlider';
import { createRange, deepEqual } from '../../util/helpers';
/* @vue/component */
export default {
    name: 'v-range-slider',
    extends: VSlider,
    props: {
        value: {
            type: Array,
            default: () => ([])
        }
    },
    data: vm => ({
        activeThumb: null,
        lazyValue: !vm.value.length
            ? [0, 0]
            : vm.value
    }),
    computed: {
        classes() {
            return Object.assign({}, {
                'v-input--range-slider': true
            }, VSlider.options.computed.classes.call(this));
        },
        internalValue: {
            get() {
                return this.lazyValue;
            },
            set(val) {
                const { min, max } = this;
                // Round value to ensure the
                // entire slider range can
                // be selected with step
                let value = val.map(v => this.roundValue(Math.min(Math.max(v, min), max)));
                // Switch values if range and wrong order
                if (value[0] > value[1] || value[1] < value[0]) {
                    if (this.activeThumb !== null)
                        this.activeThumb = this.activeThumb === 1 ? 0 : 1;
                    value = [value[1], value[0]];
                }
                this.lazyValue = value;
                if (!deepEqual(value, this.value))
                    this.$emit('input', value);
                this.validate();
            }
        },
        inputWidth() {
            return this.internalValue.map(v => (this.roundValue(v) - this.min) / (this.max - this.min) * 100);
        },
        isDirty() {
            return this.internalValue.some(v => v !== this.min) || this.alwaysDirty;
        },
        trackFillStyles() {
            const styles = VSlider.options.computed.trackFillStyles.call(this);
            const fillPercent = Math.abs(this.inputWidth[0] - this.inputWidth[1]);
            styles.width = `calc(${fillPercent}% - ${this.trackPadding}px)`;
            styles[this.$vuetify.rtl ? 'right' : 'left'] = `${this.inputWidth[0]}%`;
            return styles;
        },
        trackPadding() {
            if (this.isDirty ||
                this.internalValue[0])
                return 0;
            return VSlider.options.computed.trackPadding.call(this);
        }
    },
    methods: {
        getIndexOfClosestValue(arr, v) {
            if (Math.abs(arr[0] - v) < Math.abs(arr[1] - v))
                return 0;
            else
                return 1;
        },
        genInput() {
            return createRange(2).map(i => {
                const input = VSlider.options.methods.genInput.call(this);
                input.data.attrs.value = this.internalValue[i];
                input.data.on.focus = e => {
                    this.activeThumb = i;
                    VSlider.options.methods.onFocus.call(this, e);
                };
                return input;
            });
        },
        genChildren() {
            return [
                this.genInput(),
                this.genTrackContainer(),
                this.genSteps(),
                createRange(2).map(i => {
                    const value = this.internalValue[i];
                    const onDrag = e => {
                        this.isActive = true;
                        this.activeThumb = i;
                        this.onThumbMouseDown(e);
                    };
                    const valueWidth = this.inputWidth[i];
                    const isActive = (this.isFocused || this.isActive) && this.activeThumb === i;
                    return this.genThumbContainer(value, valueWidth, isActive, onDrag);
                })
            ];
        },
        onSliderClick(e) {
            if (!this.isActive) {
                this.isFocused = true;
                this.onMouseMove(e, true);
                this.$emit('change', this.internalValue);
            }
        },
        onMouseMove(e, trackClick = false) {
            const { value, isInsideTrack } = this.parseMouseMove(e);
            if (isInsideTrack) {
                if (trackClick)
                    this.activeThumb = this.getIndexOfClosestValue(this.internalValue, value);
                this.setInternalValue(value);
            }
        },
        onKeyDown(e) {
            const value = this.parseKeyDown(e, this.internalValue[this.activeThumb]);
            if (value == null)
                return;
            this.setInternalValue(value);
        },
        setInternalValue(value) {
            this.internalValue = this.internalValue.map((v, i) => {
                if (i === this.activeThumb)
                    return value;
                else
                    return Number(v);
            });
        }
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlJhbmdlU2xpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVlJhbmdlU2xpZGVyL1ZSYW5nZVNsaWRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTO0FBQ1QsT0FBTyw2Q0FBNkMsQ0FBQTtBQUVwRCxhQUFhO0FBQ2IsT0FBTyxPQUFPLE1BQU0sWUFBWSxDQUFBO0FBRWhDLE9BQU8sRUFDTCxXQUFXLEVBQ1gsU0FBUyxFQUNWLE1BQU0sb0JBQW9CLENBQUE7QUFFM0Isb0JBQW9CO0FBQ3BCLGVBQWU7SUFDYixJQUFJLEVBQUUsZ0JBQWdCO0lBRXRCLE9BQU8sRUFBRSxPQUFPO0lBRWhCLEtBQUssRUFBRTtRQUNMLEtBQUssRUFBRTtZQUNMLElBQUksRUFBRSxLQUFLO1lBQ1gsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDO1NBQ3BCO0tBQ0Y7SUFFRCxJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1gsV0FBVyxFQUFFLElBQUk7UUFDakIsU0FBUyxFQUFFLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNO1lBQ3pCLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDUixDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUs7S0FDYixDQUFDO0lBRUYsUUFBUSxFQUFFO1FBQ1IsT0FBTztZQUNMLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUU7Z0JBQ3ZCLHVCQUF1QixFQUFFLElBQUk7YUFDOUIsRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7UUFDakQsQ0FBQztRQUNELGFBQWEsRUFBRTtZQUNiLEdBQUc7Z0JBQ0QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFBO1lBQ3ZCLENBQUM7WUFDRCxHQUFHLENBQUUsR0FBRztn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QUFDLENBQUE7Z0JBRXpGLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQTthQUM3QjtRQUNILENBQUM7UUFDRCxTQUFTLENBQUUsQ0FBQztZQUNWLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUE7WUFFeEUsSUFBSSxLQUFLLElBQUksSUFBSTtnQkFBRSxPQUFNO1lBRXpCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUM5QixDQUFDO1FBQ0QsZ0JBQWdCLENBQUUsS0FBSztZQUNyQixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUNuRCxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsV0FBVztvQkFBRSxPQUFPLEtBQUssQ0FBQTs7b0JBQ25DLE9BQU8sTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ3ZCLENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQztLQUNGO0NBQ0YsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIFN0eWxlc1xyXG5pbXBvcnQgJy4uLy4uL3N0eWx1cy9jb21wb25lbnRzL19yYW5nZS1zbGlkZXJzLnN0eWwnXHJcblxyXG4vLyBFeHRlbnNpb25zXHJcbmltcG9ydCBWU2xpZGVyIGZyb20gJy4uL1ZTbGlkZXInXHJcblxyXG5pbXBvcnQge1xyXG4gIGNyZWF0ZVJhbmdlLFxyXG4gIGRlZXBFcXVhbFxyXG59IGZyb20gJy4uLy4uL3V0aWwvaGVscGVycydcclxuXHJcbi8qIEB2dWUvY29tcG9uZW50ICovXHJcbmV4cG9ydCBkZWZhdWx0IHtcclxuICBuYW1lOiAndi1yYW5nZS1zbGlkZXInLFxyXG5cclxuICBleHRlbmRzOiBWU2xpZGVyLFxyXG5cclxuICBwcm9wczoge1xyXG4gICAgdmFsdWU6IHtcclxuICAgICAgdHlwZTogQXJyYXksXHJcbiAgICAgIGRlZmF1bHQ6ICgpID0+IChbXSlcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBkYXRhOiB2bSA9PiAoe1xyXG4gICAgYWN0aXZlVGh1bWI6IG51bGwsXHJcbiAgICBsYXp5VmFsdWU6ICF2bS52YWx1ZS5sZW5ndGhcclxuICAgICAgPyBbMCwgMF1cclxuICAgICAgOiB2bS52YWx1ZVxyXG4gIH0pLFxyXG5cclxuICBjb21wdXRlZDoge1xyXG4gICAgY2xhc3NlcyAoKSB7XHJcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCB7XHJcbiAgICAgICAgJ3YtaW5wdXQtLXJhbmdlLXNsaWRlcic6IHRydWVcclxuICAgICAgfSwgVlNsaWRlci5vcHRpb25zLmNvbXB1dGVkLmNsYXNzZXMuY2FsbCh0aGlzKSlcclxuICAgIH0sXHJcbiAgICBpbnRlcm5hbFZhbHVlOiB7XHJcbiAgICAgIGdldCAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubGF6eVZhbHVlXHJcbiAgICAgIH0sXHJcbiAgICAgIHNldCAodmFsKSB7XHJcbiAgICAgICAgY29uc3QgeyBtaW4sIG1heCB9ID0gdGhpc1xyXG4gICAgICAgIC8vIFJvdW5kIHZhbHVlIHRvIGVuc3VyZSB0aGVcclxuICAgICAgICAvLyBlbnRpcmUgc2xpZGVyIHJhbmdlIGNhblxyXG4gICAgICAgIC8vIGJlIHNlbGVjdGVkIHdpdGggc3RlcFxyXG4gICAgICAgIGxldCB2YWx1ZSA9IHZhbC5tYXAodiA9PiB0aGlzLnJvdW5kVmFsdWUoTWF0aC5taW4oTWF0aC5tYXgodiwgbWluKSwgbWF4KSkpXHJcblxyXG4gICAgICAgIC8vIFN3aXRjaCB2YWx1ZXMgaWYgcmFuZ2UgYW5kIHdyb25nIG9yZGVyXHJcbiAgICAgICAgaWYgKHZhbHVlWzBdID4gdmFsdWVbMV0gfHwgdmFsdWVbMV0gPCB2YWx1ZVswXSkge1xyXG4gICAgICAgICAgaWYgKHRoaXMuYWN0aXZlVGh1bWIgIT09IG51bGwpIHRoaXMuYWN0aXZlVGh1bWIgPSB0aGlzLmFjdGl2ZVRodW1iID09PSAxID8gMCA6IDFcclxuICAgICAgICAgIHZhbHVlID0gW3ZhbHVlWzFdLCB2YWx1ZVswXV1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMubGF6eVZhbHVlID0gdmFsdWVcclxuICAgICAgICBpZiAoIWRlZXBFcXVhbCh2YWx1ZSwgdGhpcy52YWx1ZSkpIHRoaXMuJGVtaXQoJ2lucHV0JywgdmFsdWUpXHJcblxyXG4gICAgICAgIHRoaXMudmFsaWRhdGUoKVxyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgaW5wdXRXaWR0aCAoKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmludGVybmFsVmFsdWUubWFwKHYgPT4gKFxyXG4gICAgICAgIHRoaXMucm91bmRWYWx1ZSh2KSAtIHRoaXMubWluKSAvICh0aGlzLm1heCAtIHRoaXMubWluKSAqIDEwMFxyXG4gICAgICApXHJcbiAgICB9LFxyXG4gICAgaXNEaXJ0eSAoKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmludGVybmFsVmFsdWUuc29tZSh2ID0+IHYgIT09IHRoaXMubWluKSB8fCB0aGlzLmFsd2F5c0RpcnR5XHJcbiAgICB9LFxyXG4gICAgdHJhY2tGaWxsU3R5bGVzICgpIHtcclxuICAgICAgY29uc3Qgc3R5bGVzID0gVlNsaWRlci5vcHRpb25zLmNvbXB1dGVkLnRyYWNrRmlsbFN0eWxlcy5jYWxsKHRoaXMpXHJcbiAgICAgIGNvbnN0IGZpbGxQZXJjZW50ID0gTWF0aC5hYnModGhpcy5pbnB1dFdpZHRoWzBdIC0gdGhpcy5pbnB1dFdpZHRoWzFdKVxyXG5cclxuICAgICAgc3R5bGVzLndpZHRoID0gYGNhbGMoJHtmaWxsUGVyY2VudH0lIC0gJHt0aGlzLnRyYWNrUGFkZGluZ31weClgXHJcbiAgICAgIHN0eWxlc1t0aGlzLiR2dWV0aWZ5LnJ0bCA/ICdyaWdodCcgOiAnbGVmdCddID0gYCR7dGhpcy5pbnB1dFdpZHRoWzBdfSVgXHJcblxyXG4gICAgICByZXR1cm4gc3R5bGVzXHJcbiAgICB9LFxyXG4gICAgdHJhY2tQYWRkaW5nICgpIHtcclxuICAgICAgaWYgKHRoaXMuaXNEaXJ0eSB8fFxyXG4gICAgICAgIHRoaXMuaW50ZXJuYWxWYWx1ZVswXVxyXG4gICAgICApIHJldHVybiAwXHJcblxyXG4gICAgICByZXR1cm4gVlNsaWRlci5vcHRpb25zLmNvbXB1dGVkLnRyYWNrUGFkZGluZy5jYWxsKHRoaXMpXHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgbWV0aG9kczoge1xyXG4gICAgZ2V0SW5kZXhPZkNsb3Nlc3RWYWx1ZSAoYXJyLCB2KSB7XHJcbiAgICAgIGlmIChNYXRoLmFicyhhcnJbMF0gLSB2KSA8IE1hdGguYWJzKGFyclsxXSAtIHYpKSByZXR1cm4gMFxyXG4gICAgICBlbHNlIHJldHVybiAxXHJcbiAgICB9LFxyXG4gICAgZ2VuSW5wdXQgKCkge1xyXG4gICAgICByZXR1cm4gY3JlYXRlUmFuZ2UoMikubWFwKGkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGlucHV0ID0gVlNsaWRlci5vcHRpb25zLm1ldGhvZHMuZ2VuSW5wdXQuY2FsbCh0aGlzKVxyXG5cclxuICAgICAgICBpbnB1dC5kYXRhLmF0dHJzLnZhbHVlID0gdGhpcy5pbnRlcm5hbFZhbHVlW2ldXHJcblxyXG4gICAgICAgIGlucHV0LmRhdGEub24uZm9jdXMgPSBlID0+IHtcclxuICAgICAgICAgIHRoaXMuYWN0aXZlVGh1bWIgPSBpXHJcbiAgICAgICAgICBWU2xpZGVyLm9wdGlvbnMubWV0aG9kcy5vbkZvY3VzLmNhbGwodGhpcywgZSlcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBpbnB1dFxyXG4gICAgICB9KVxyXG4gICAgfSxcclxuICAgIGdlbkNoaWxkcmVuICgpIHtcclxuICAgICAgcmV0dXJuIFtcclxuICAgICAgICB0aGlzLmdlbklucHV0KCksXHJcbiAgICAgICAgdGhpcy5nZW5UcmFja0NvbnRhaW5lcigpLFxyXG4gICAgICAgIHRoaXMuZ2VuU3RlcHMoKSxcclxuICAgICAgICBjcmVhdGVSYW5nZSgyKS5tYXAoaSA9PiB7XHJcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuaW50ZXJuYWxWYWx1ZVtpXVxyXG4gICAgICAgICAgY29uc3Qgb25EcmFnID0gZSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuaXNBY3RpdmUgPSB0cnVlXHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlVGh1bWIgPSBpXHJcbiAgICAgICAgICAgIHRoaXMub25UaHVtYk1vdXNlRG93bihlKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgdmFsdWVXaWR0aCA9IHRoaXMuaW5wdXRXaWR0aFtpXVxyXG4gICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSAodGhpcy5pc0ZvY3VzZWQgfHwgdGhpcy5pc0FjdGl2ZSkgJiYgdGhpcy5hY3RpdmVUaHVtYiA9PT0gaVxyXG5cclxuICAgICAgICAgIHJldHVybiB0aGlzLmdlblRodW1iQ29udGFpbmVyKHZhbHVlLCB2YWx1ZVdpZHRoLCBpc0FjdGl2ZSwgb25EcmFnKVxyXG4gICAgICAgIH0pXHJcbiAgICAgIF1cclxuICAgIH0sXHJcbiAgICBvblNsaWRlckNsaWNrIChlKSB7XHJcbiAgICAgIGlmICghdGhpcy5pc0FjdGl2ZSkge1xyXG4gICAgICAgIHRoaXMuaXNGb2N1c2VkID0gdHJ1ZVxyXG4gICAgICAgIHRoaXMub25Nb3VzZU1vdmUoZSwgdHJ1ZSlcclxuICAgICAgICB0aGlzLiRlbWl0KCdjaGFuZ2UnLCB0aGlzLmludGVybmFsVmFsdWUpXHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICBvbk1vdXNlTW92ZSAoZSwgdHJhY2tDbGljayA9IGZhbHNlKSB7XHJcbiAgICAgIGNvbnN0IHsgdmFsdWUsIGlzSW5zaWRlVHJhY2sgfSA9IHRoaXMucGFyc2VNb3VzZU1vdmUoZSlcclxuXHJcbiAgICAgIGlmIChpc0luc2lkZVRyYWNrKSB7XHJcbiAgICAgICAgaWYgKHRyYWNrQ2xpY2spIHRoaXMuYWN0aXZlVGh1bWIgPSB0aGlzLmdldEluZGV4T2ZDbG9zZXN0VmFsdWUodGhpcy5pbnRlcm5hbFZhbHVlLCB2YWx1ZSlcclxuXHJcbiAgICAgICAgdGhpcy5zZXRJbnRlcm5hbFZhbHVlKHZhbHVlKVxyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgb25LZXlEb3duIChlKSB7XHJcbiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5wYXJzZUtleURvd24oZSwgdGhpcy5pbnRlcm5hbFZhbHVlW3RoaXMuYWN0aXZlVGh1bWJdKVxyXG5cclxuICAgICAgaWYgKHZhbHVlID09IG51bGwpIHJldHVyblxyXG5cclxuICAgICAgdGhpcy5zZXRJbnRlcm5hbFZhbHVlKHZhbHVlKVxyXG4gICAgfSxcclxuICAgIHNldEludGVybmFsVmFsdWUgKHZhbHVlKSB7XHJcbiAgICAgIHRoaXMuaW50ZXJuYWxWYWx1ZSA9IHRoaXMuaW50ZXJuYWxWYWx1ZS5tYXAoKHYsIGkpID0+IHtcclxuICAgICAgICBpZiAoaSA9PT0gdGhpcy5hY3RpdmVUaHVtYikgcmV0dXJuIHZhbHVlXHJcbiAgICAgICAgZWxzZSByZXR1cm4gTnVtYmVyKHYpXHJcbiAgICAgIH0pXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==